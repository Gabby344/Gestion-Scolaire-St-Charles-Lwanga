<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion √âl√®ves - Institut Saint Charles Lwanga</title>
    <style>
        /* STYLES EXISTANTS... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #2c3e50; --secondary: #3498db; --success: #27ae60; --warning: #f39c12; --danger: #e74c3c; --shadow: 0 4px 6px rgba(0,0,0,0.1); --radius: 10px; }
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; min-height: 100vh; color: #333; }
        
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--primary); color: white; position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-header { padding: 25px 20px; text-align: center; border-bottom: 1px solid #34495e; background: rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; padding: 15px 20px; background: rgba(0,0,0,0.2); margin: 10px; border-radius: 8px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .sidebar-menu { padding: 20px 0; }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.3s; border-left: 4px solid transparent; }
        .menu-item:hover { background: #34495e; border-left-color: var(--secondary); }
        .menu-item.active { background: var(--secondary); border-left-color: white; }
        
        .main-content { margin-left: 280px; flex: 1; }
        .top-header { background: white; padding: 0 30px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .content-area { padding: 30px; background: #f8f9fa; min-height: calc(100vh - 70px); }
        .page-header { background: white; padding: 25px 30px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        
        .search-bar { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .search-bar input, .search-bar select { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-width: 200px; }
        .action-buttons { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--secondary); color: white; } .btn-success { background: var(--success); color: white; } .btn-danger { background: var(--danger); color: white; } .btn-warning { background: var(--warning); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; } .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; border-top: 4px solid var(--secondary); }
        .stat-card.success { border-top-color: var(--success); } .stat-card.warning { border-top-color: var(--warning); } .stat-card.danger { border-top-color: var(--danger); }
        .stat-number { font-size: 2.5em; font-weight: bold; color: var(--secondary); display: block; }
        .stat-card.success .stat-number { color: var(--success); } .stat-card.warning .stat-number { color: var(--warning); } .stat-card.danger .stat-number { color: var(--danger); }
        .stat-label { color: #666; margin-top: 8px; font-size: 0.9em; }
        
        .data-card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 25px; }
        .card-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; } th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: var(--dark); } tr:hover { background: #f8f9fa; }
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; } .badge-warning { background: #fff3cd; color: #856404; } .badge-danger { background: #f8d7da; color: #721c24; } .badge-primary { background: #d1ecf1; color: #0c5460; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: var(--radius); box-shadow: var(--shadow); width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; } .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--secondary); }
        
        .photo-upload { text-align: center; border: 2px dashed #e0e0e0; border-radius: 8px; padding: 20px; cursor: pointer; transition: border-color 0.3s; }
        .photo-upload:hover { border-color: var(--secondary); }
        .photo-preview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin: 0 auto 15px; display: none; }
        
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .main-content { margin-left: 0; } .form-row { grid-template-columns: 1fr; } .search-bar { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="logosaintcharles.JPG" alt="Logo">
                <h3>Saint Charles Lwanga</h3>
                <p style="opacity: 0.8; font-size: 0.9em;">Kolwezi</p>
            </div>

            <div class="user-info">
                <img id="userAvatar" class="user-avatar" src="" alt="Utilisateur">
                <div>
                    <div id="userName" style="font-weight: 600;">Chargement...</div>
                    <div id="userRole" style="font-size: 0.8em; opacity: 0.8;">Chargement...</div>
                </div>
            </div>

            <div class="sidebar-menu">
                <div class="menu-item" onclick="window.location.href='dashboard.html'">üìä Tableau de Bord</div>
                <div class="menu-item active">üë®‚Äçüéì √âl√®ves</div>
                <div class="menu-item" onclick="window.location.href='enseignants.html'">üë®‚Äçüè´ Enseignants</div>
                <div class="menu-item" onclick="showNotification('Module classes - En d√©veloppement')">üè´ Classes</div>
                <div class="menu-item" onclick="showNotification('Module notes - En d√©veloppement')">üìù Notes</div>
                <div class="menu-item" onclick="logout()" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #34495e;">üö™ D√©connexion</div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="top-header">
                <h2>Gestion des √âl√®ves</h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="currentDate" style="color: #666;"></span>
                    <span id="userBadge" class="badge badge-success">CHARGEMENT</span>
                </div>
            </div>

            <div class="content-area">
                <!-- EN-T√äTE -->
                <div class="page-header">
                    <div>
                        <h1 style="margin-bottom: 5px;">Gestion des √âl√®ves</h1>
                        <p style="color: #666;">Inscription, modification et suivi des √©l√®ves</p>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="exportEleves()">üìä Exporter</button>
                        <button class="btn btn-success" onclick="showAddEleveModal()">‚ûï Nouvel √âl√®ve</button>
                    </div>
                </div>

                <!-- BARRE DE RECHERCHE -->
                <div class="search-bar">
                    <input type="text" id="searchEleves" placeholder="Rechercher un √©l√®ve..." style="flex: 1;">
                    <select id="filterClasse">
                        <option value="">Toutes les classes</option>
                        <option value="7√®me EB">7√®me EB</option>
                        <option value="8√®me EB">8√®me EB</option>
                        <option value="1√®re P√©dagogie">1√®re P√©dagogie</option>
                        <option value="2√®me P√©dagogie">2√®me P√©dagogie</option>
                        <option value="3√®me Commerciale">3√®me Commerciale</option>
                        <option value="4√®me Scientifique">4√®me Scientifique</option>
                        <option value="1√®re Agronomie">1√®re Agronomie</option>
                    </select>
                    <select id="filterStatut">
                        <option value="">Tous les statuts</option>
                        <option value="Actif">Actif</option>
                        <option value="Inactif">Inactif</option>
                        <option value="Dipl√¥m√©">Dipl√¥m√©</option>
                        <option value="Exclu">Exclu</option>
                    </select>
                    <button class="btn btn-primary" onclick="searchEleves()">üîç Rechercher</button>
                </div>

                <!-- STATISTIQUES -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalElevesCount">0</div>
                        <div class="stat-label">√âl√®ves total</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number" id="elevesActifsCount">0</div>
                        <div class="stat-label">√âl√®ves actifs</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number" id="nouveauxElevesCount">0</div>
                        <div class="stat-label">Nouveaux cette ann√©e</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-number" id="elevesProblemesCount">0</div>
                        <div class="stat-label">Cas probl√©matiques</div>
                    </div>
                </div>

                <!-- TABLEAU DES √âL√àVES -->
                <div class="data-card">
                    <div class="card-header">
                        <h3>Liste des √âl√®ves</h3>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="loadElevesFromFirebase()">üîÑ Actualiser</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Matricule</th>
                                <th>Nom Complet</th>
                                <th>Classe</th>
                                <th>T√©l√©phone</th>
                                <th>Date Inscription</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="elevesTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                    Chargement depuis Firebase...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AJOUT √âL√àVE -->
    <div id="addEleveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Inscription d'un Nouvel √âl√®ve</h3>
                <button onclick="closeModal('addEleveModal')" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úñ</button>
            </div>
            <div class="modal-body">
                <form id="addEleveForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eleveMatricule">Matricule *</label>
                            <input type="text" id="eleveMatricule" required placeholder="SCL2024-001">
                        </div>
                        <div class="form-group">
                            <label for="eleveClasse">Classe *</label>
                            <select id="eleveClasse" required>
                                <option value="">Choisir une classe</option>
                                <option value="7√®me EB">7√®me EB</option>
                                <option value="8√®me EB">8√®me EB</option>
                                <option value="1√®re P√©dagogie">1√®re P√©dagogie</option>
                                <option value="2√®me P√©dagogie">2√®me P√©dagogie</option>
                                <option value="3√®me Commerciale">3√®me Commerciale</option>
                                <option value="4√®me Scientifique">4√®me Scientifique</option>
                                <option value="1√®re Agronomie">1√®re Agronomie</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="eleveNom">Nom *</label>
                            <input type="text" id="eleveNom" required placeholder="Mbayo">
                        </div>
                        <div class="form-group">
                            <label for="elevePostnom">Postnom</label>
                            <input type="text" id="elevePostnom" placeholder="Kabasele">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="elevePrenom">Pr√©nom *</label>
                            <input type="text" id="elevePrenom" required placeholder="Sarah">
                        </div>
                        <div class="form-group">
                            <label for="eleveSexe">Sexe *</label>
                            <select id="eleveSexe" required>
                                <option value="">Choisir</option>
                                <option value="M">Masculin</option>
                                <option value="F">F√©minin</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="eleveDateNaissance">Date de Naissance *</label>
                            <input type="date" id="eleveDateNaissance" required>
                        </div>
                        <div class="form-group">
                            <label for="eleveLieuNaissance">Lieu de Naissance</label>
                            <input type="text" id="eleveLieuNaissance" placeholder="Kolwezi">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="eleveAdresse">Adresse</label>
                        <textarea id="eleveAdresse" rows="2" placeholder="Adresse compl√®te"></textarea>
                    </div>

                    <h4 style="margin: 20px 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #eee;">Informations du Tuteur</h4>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tuteurNom">Nom du Tuteur *</label>
                            <input type="text" id="tuteurNom" required placeholder="Paul Kabasele">
                        </div>
                        <div class="form-group">
                            <label for="tuteurTelephone">T√©l√©phone *</label>
                            <input type="tel" id="tuteurTelephone" required placeholder="+243...">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tuteurEmail">Email</label>
                            <input type="email" id="tuteurEmail" placeholder="tuteur@email.com">
                        </div>
                        <div class="form-group">
                            <label for="tuteurLien">Lien de parent√© *</label>
                            <select id="tuteurLien" required>
                                <option value="">Choisir</option>
                                <option value="P√®re">P√®re</option>
                                <option value="M√®re">M√®re</option>
                                <option value="Tuteur">Tuteur</option>
                                <option value="Fr√®re">Fr√®re</option>
                                <option value="S≈ìur">S≈ìur</option>
                                <option value="Oncle">Oncle</option>
                                <option value="Tante">Tante</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tuteurAdresse">Adresse du Tuteur</label>
                        <textarea id="tuteurAdresse" rows="2" placeholder="Adresse du tuteur"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Photo de l'√©l√®ve</label>
                        <div class="photo-upload" onclick="document.getElementById('elevePhoto').click()">
                            <img id="photoPreview" class="photo-preview" alt="Aper√ßu photo">
                            <div id="uploadText">
                                <div style="font-size: 3em;">üì∑</div>
                                <div>Cliquer pour ajouter une photo</div>
                                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">JPG, PNG - Max 2MB</div>
                            </div>
                        </div>
                        <input type="file" id="elevePhoto" accept="image/*" style="display: none;" onchange="previewPhoto(event)">
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('addEleveModal')">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-success" style="flex: 1;">
                            üíæ Enregistrer l'√âl√®ve
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        // === CONFIGURATION FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyDTM4gdOs_Ud3DC49pmammYMlDH3cSSgZs",
            authDomain: "gestion-scolaire-st-charles.firebaseapp.com",
            projectId: "gestion-scolaire-st-charles",
            storageBucket: "gestion-scolaire-st-charles.firebasestorage.app",
            messagingSenderId: "1033368821503",
            appId: "1:1033368821503:web:a4ba1c8d439193c5f336ca"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // === DONN√âES DES √âL√àVES ===
        let eleves = [];
        let filteredEleves = [];

        // === CHARGEMENT DEPUIS FIREBASE ===
        async function loadElevesFromFirebase() {
            try {
                console.log('üîÑ Chargement des √©l√®ves depuis Firebase...');
                
                const querySnapshot = await db.collection('eleves').orderBy('dateCreation', 'desc').get();
                eleves = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    eleves.push({
                        id: doc.id,
                        ...data
                    });
                });

                console.log(`‚úÖ ${eleves.length} √©l√®ves charg√©s depuis Firebase`);
                
                // Si pas d'√©l√®ves, cr√©er des donn√©es de d√©mo
                if (eleves.length === 0) {
                    await createDemoEleves();
                } else {
                    filteredEleves = [...eleves];
                    updateElevesDisplay();
                    updateElevesStats();
                }

            } catch (error) {
                console.error('‚ùå Erreur Firebase:', error);
                showNotification('Erreur de chargement des donn√©es', 'error');
            }
        }

        // === CR√âATION DE DONN√âES DE D√âMO SI FIREBASE EST VIDE ===
        async function createDemoEleves() {
            const demoEleves = [
                {
                    matricule: "SCL2024-001",
                    nom: "Mbayo",
                    postnom: "Kabasele",
                    prenom: "Sarah",
                    sexe: "F",
                    classe: "4√®me Scientifique",
                    dateNaissance: "2008-05-15",
                    telephone: "+243 97 123 4567",
                    dateInscription: "2024-01-15",
                    statut: "Actif",
                    tuteur: {
                        nom: "Paul Kabasele",
                        telephone: "+243 81 234 5678",
                        email: "paul.kabasele@email.com",
                        lien: "P√®re",
                        adresse: "123 Av. Lumumba, Kolwezi"
                    },
                    adresse: "123 Av. Lumumba, Kolwezi"
                },
                {
                    matricule: "SCL2024-002", 
                    nom: "Kalonga",
                    postnom: "Mwamba",
                    prenom: "David",
                    sexe: "M",
                    classe: "3√®me Commerciale",
                    dateNaissance: "2007-08-22",
                    telephone: "+243 90 987 6543",
                    dateInscription: "2024-01-10",
                    statut: "Actif",
                    tuteur: {
                        nom: "Marie Mwamba",
                        telephone: "+243 89 876 5432",
                        email: "marie.mwamba@email.com",
                        lien: "M√®re",
                        adresse: "456 Rue Kasa√Ø, Kolwezi"
                    },
                    adresse: "456 Rue Kasa√Ø, Kolwezi"
                },
                {
                    matricule: "SCL2024-003",
                    nom: "Tshibangu",
                    postnom: "Mbuyi", 
                    prenom: "Julie",
                    sexe: "F",
                    classe: "2√®me P√©dagogie",
                    dateNaissance: "2006-12-03",
                    telephone: "+243 97 555 4444",
                    dateInscription: "2024-01-12",
                    statut: "Actif",
                    tuteur: {
                        nom: "Jean Tshibangu",
                        telephone: "+243 82 333 2222",
                        email: "jean.tshibangu@email.com",
                        lien: "P√®re",
                        adresse: "789 Bd du 30 Juin, Kolwezi"
                    },
                    adresse: "789 Bd du 30 Juin, Kolwezi"
                }
            ];

            try {
                const batch = db.batch();
                
                demoEleves.forEach(eleve => {
                    const docRef = db.collection('eleves').doc();
                    batch.set(docRef, {
                        ...eleve,
                        dateCreation: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: 'system'
                    });
                });

                await batch.commit();
                console.log('‚úÖ Donn√©es de d√©mo cr√©√©es dans Firebase');
                await loadElevesFromFirebase();
                
            } catch (error) {
                console.error('‚ùå Erreur cr√©ation donn√©es d√©mo:', error);
            }
        }

        // === SAUVEGARDE D'UN NOUVEL √âL√àVE ===
        async function saveEleveToFirebase(eleveData) {
            try {
                const docRef = await db.collection('eleves').add({
                    ...eleveData,
                    dateCreation: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: JSON.parse(localStorage.getItem('currentUser')).email
                });

                console.log('‚úÖ √âl√®ve sauvegard√© avec ID:', docRef.id);
                return docRef.id;
                
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde:', error);
                throw error;
            }
        }

        // === SUPPRESSION D'UN √âL√àVE ===
        async function deleteEleveFromFirebase(eleveId) {
            try {
                await db.collection('eleves').doc(eleveId).delete();
                console.log('‚úÖ √âl√®ve supprim√©:', eleveId);
                return true;
            } catch (error) {
                console.error('‚ùå Erreur suppression:', error);
                throw error;
            }
        }

        // === UPLOAD DE PHOTO ===
        async function uploadElevePhoto(file, eleveId) {
            try {
                const storageRef = storage.ref();
                const photoRef = storageRef.child(`eleves/${eleveId}/${file.name}`);
                const snapshot = await photoRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                return downloadURL;
            } catch (error) {
                console.error('‚ùå Erreur upload photo:', error);
                throw error;
            }
        }

        // === MISE √Ä JOUR DE L'AFFICHAGE ===
        function updateElevesDisplay() {
            const tbody = document.getElementById('elevesTable');
            
            if (filteredEleves.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            Aucun √©l√®ve trouv√©
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredEleves.map(eleve => `
                <tr>
                    <td><strong>${eleve.matricule}</strong></td>
                    <td>
                        <div style="font-weight: 600;">${eleve.nom} ${eleve.prenom}</div>
                        <div style="font-size: 0.8em; color: #666;">${eleve.postnom || ''}</div>
                    </td>
                    <td>${eleve.classe}</td>
                    <td>${eleve.telephone}</td>
                    <td>${formatDate(eleve.dateInscription)}</td>
                    <td><span class="badge ${getStatutBadgeClass(eleve.statut)}">${eleve.statut}</span></td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-sm btn-primary" onclick="viewEleve('${eleve.id}')">
                                üëÅÔ∏è
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editEleve('${eleve.id}')">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEleve('${eleve.id}')">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateElevesStats() {
            document.getElementById('totalElevesCount').textContent = eleves.length;
            document.getElementById('elevesActifsCount').textContent = eleves.filter(e => e.statut === 'Actif').length;
            document.getElementById('nouveauxElevesCount').textContent = eleves.filter(e => e.dateInscription.includes('2024')).length;
            document.getElementById('elevesProblemesCount').textContent = 0;
        }

        // === FONCTIONS DE RECHERCHE ===
        function searchEleves() {
            const searchTerm = document.getElementById('searchEleves').value.toLowerCase();
            const classeFilter = document.getElementById('filterClasse').value;
            const statutFilter = document.getElementById('filterStatut').value;

            filteredEleves = eleves.filter(eleve => {
                const matchesSearch = !searchTerm || 
                    eleve.nom.toLowerCase().includes(searchTerm) ||
                    eleve.prenom.toLowerCase().includes(searchTerm) ||
                    eleve.matricule.toLowerCase().includes(searchTerm);
                
                const matchesClasse = !classeFilter || eleve.classe === classeFilter;
                const matchesStatut = !statutFilter || eleve.statut === statutFilter;

                return matchesSearch && matchesClasse && matchesStatut;
            });

            updateElevesDisplay();
        }

        // === GESTION MODAL ===
        function showAddEleveModal() {
            document.getElementById('addEleveForm').reset();
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('uploadText').style.display = 'block';
            document.getElementById('addEleveModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('photoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    document.getElementById('uploadText').style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }

        // === GESTION FORMULAIRE ===
        document.getElementById('addEleveForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const eleveData = {
                matricule: document.getElementById('eleveMatricule').value,
                nom: document.getElementById('eleveNom').value,
                postnom: document.getElementById('elevePostnom').value,
                prenom: document.getElementById('elevePrenom').value,
                sexe: document.getElementById('eleveSexe').value,
                classe: document.getElementById('eleveClasse').value,
                dateNaissance: document.getElementById('eleveDateNaissance').value,
                lieuNaissance: document.getElementById('eleveLieuNaissance').value,
                adresse: document.getElementById('eleveAdresse').value,
                telephone: document.getElementById('tuteurTelephone').value,
                dateInscription: new Date().toISOString().split('T')[0],
                statut: "Actif",
                tuteur: {
                    nom: document.getElementById('tuteurNom').value,
                    telephone: document.getElementById('tuteurTelephone').value,
                    email: document.getElementById('tuteurEmail').value,
                    lien: document.getElementById('tuteurLien').value,
                    adresse: document.getElementById('tuteurAdresse').value
                }
            };

            try {
                // Sauvegarde dans Firebase
                const eleveId = await saveEleveToFirebase(eleveData);
                
                // Upload de la photo si elle existe
                const photoFile = document.getElementById('elevePhoto').files[0];
                if (photoFile) {
                    try {
                        const photoURL = await uploadElevePhoto(photoFile, eleveId);
                        // Mettre √† jour l'√©l√®ve avec l'URL de la photo
                        await db.collection('eleves').doc(eleveId).update({
                            photoURL: photoURL
                        });
                        eleveData.photoURL = photoURL;
                    } catch (photoError) {
                        console.warn('‚ö†Ô∏è Erreur upload photo, mais √©l√®ve sauvegard√©');
                    }
                }

                // Ajouter √† la liste locale
                eleves.unshift({
                    id: eleveId,
                    ...eleveData
                });
                filteredEleves = [...eleves];

                updateElevesDisplay();
                updateElevesStats();
                closeModal('addEleveModal');
                showNotification('√âl√®ve enregistr√© avec succ√®s!', 'success');
                
            } catch (error) {
                showNotification('Erreur lors de la sauvegarde', 'error');
            }
        });

        // === ACTIONS SUR √âL√àVES ===
        function viewEleve(eleveId) {
            const eleve = eleves.find(e => e.id === eleveId);
            const message = `
D√©tails de l'√©l√®ve:

üìã Matricule: ${eleve.matricule}
üë§ Nom: ${eleve.nom} ${eleve.prenom}
üè´ Classe: ${eleve.classe}
üìû T√©l√©phone: ${eleve.telephone}
üìÖ Date inscription: ${formatDate(eleve.dateInscription)}
üéÇ Date naissance: ${formatDate(eleve.dateNaissance)}
üè† Adresse: ${eleve.adresse || 'Non renseign√©e'}

üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Tuteur:
   ‚Ä¢ Nom: ${eleve.tuteur.nom}
   ‚Ä¢ T√©l√©phone: ${eleve.tuteur.telephone}
   ‚Ä¢ Lien: ${eleve.tuteur.lien}
   ‚Ä¢ Email: ${eleve.tuteur.email || 'Non renseign√©'}
   ‚Ä¢ Adresse: ${eleve.tuteur.adresse || 'Non renseign√©e'}
            `;
            alert(message);
        }

        function editEleve(eleveId) {
            showNotification(`Modification de l'√©l√®ve ${eleveId} - Fonctionnalit√© en d√©veloppement`, 'info');
        }

        async function deleteEleve(eleveId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet √©l√®ve ? Cette action est irr√©versible.')) {
                try {
                    await deleteEleveFromFirebase(eleveId);
                    
                    eleves = eleves.filter(e => e.id !== eleveId);
                    filteredEleves = filteredEleves.filter(e => e.id !== eleveId);
                    
                    updateElevesDisplay();
                    updateElevesStats();
                    showNotification('√âl√®ve supprim√© avec succ√®s', 'success');
                    
                } catch (error) {
                    showNotification('Erreur lors de la suppression', 'error');
                }
            }
        }

        function exportEleves() {
            showNotification('Exportation des donn√©es en cours...', 'info');
            setTimeout(() => {
                showNotification('Donn√©es export√©es avec succ√®s!', 'success');
            }, 1500);
        }

        // === FONCTIONS UTILITAIRES ===
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR');
        }

        function getStatutBadgeClass(statut) {
            const classes = {
                'Actif': 'badge-success',
                'Inactif': 'badge-warning',
                'Dipl√¥m√©': 'badge-primary',
                'Exclu': 'badge-danger'
            };
            return classes[statut] || 'badge-info';
        }

        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--secondary)'};
                color: white;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function logout() {
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }

        // === INITIALISATION ===
        document.addEventListener('DOMContentLoaded', async function() {
            // V√©rifier la connexion
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Charger les donn√©es
            loadUserInfo();
            await loadElevesFromFirebase();
            updateDate();

            // CSS pour animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            console.log('üë• Module √©l√®ves charg√© avec Firebase');
        });

        function loadUserInfo() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.nom;
                document.getElementById('userRole').textContent = getRoleLabel(currentUser.role);
                document.getElementById('userBadge').textContent = getRoleBadge(currentUser.role);
                document.getElementById('userBadge').className = `badge ${getRoleBadgeClass(currentUser.role)}`;
                
                if (currentUser.photo) {
                    document.getElementById('userAvatar').src = currentUser.photo;
                }
            }
        }

        function updateDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
        }

        function getRoleLabel(role) {
            const roles = {
                'prefet': 'Pr√©fet des √âtudes',
                'directeur_etudes': 'Directeur des √âtudes',
                'directeur_discipline': 'Directeur de Discipline',
                'econome': '√âconome',
                'secretaire': 'Secr√©taire',
                'enseignant': 'Enseignant',
                'eleve': '√âl√®ve'
            };
            return roles[role] || 'Utilisateur';
        }

        function getRoleBadge(role) {
            const badges = {
                'prefet': 'PR√âFET',
                'directeur_etudes': 'DIRECTEUR',
                'directeur_discipline': 'DISCIPLINE', 
                'econome': '√âCONOME',
                'secretaire': 'SECR√âTAIRE',
                'enseignant': 'ENSEIGNANT',
                'eleve': '√âL√àVE'
            };
            return badges[role] || 'USER';
        }

        function getRoleBadgeClass(role) {
            const classes = {
                'prefet': 'badge-danger',
                'directeur_etudes': 'badge-primary',
                'directeur_discipline': 'badge-warning',
                'econome': 'badge-success',
                'secretaire': 'badge-info',
                'enseignant': 'badge-primary',
                'eleve': 'badge-success'
            };
            return classes[role] || 'badge-info';
        }
    </script>
</body>
</html>
