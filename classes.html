<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Classes - Institut Saint Charles Lwanga</title>
    <style>
        /* STYLES EXISTANTS... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #2c3e50; --secondary: #3498db; --success: #27ae60; --warning: #f39c12; --danger: #e74c3c; --shadow: 0 4px 6px rgba(0,0,0,0.1); --radius: 10px; }
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; min-height: 100vh; color: #333; }
        
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--primary); color: white; position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-header { padding: 25px 20px; text-align: center; border-bottom: 1px solid #34495e; background: rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; padding: 15px 20px; background: rgba(0,0,0,0.2); margin: 10px; border-radius: 8px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .sidebar-menu { padding: 20px 0; }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.3s; border-left: 4px solid transparent; }
        .menu-item:hover { background: #34495e; border-left-color: var(--secondary); }
        .menu-item.active { background: var(--secondary); border-left-color: white; }
        
        .main-content { margin-left: 280px; flex: 1; }
        .top-header { background: white; padding: 0 30px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .content-area { padding: 30px; background: #f8f9fa; min-height: calc(100vh - 70px); }
        .page-header { background: white; padding: 25px 30px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        
        .search-bar { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .search-bar input, .search-bar select { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-width: 200px; }
        .action-buttons { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--secondary); color: white; } .btn-success { background: var(--success); color: white; } .btn-danger { background: var(--danger); color: white; } .btn-warning { background: var(--warning); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; } .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; border-top: 4px solid var(--secondary); }
        .stat-card.success { border-top-color: var(--success); } .stat-card.warning { border-top-color: var(--warning); } .stat-card.danger { border-top-color: var(--danger); }
        .stat-number { font-size: 2.5em; font-weight: bold; color: var(--secondary); display: block; }
        .stat-card.success .stat-number { color: var(--success); } .stat-card.warning .stat-number { color: var(--warning); } .stat-card.danger .stat-number { color: var(--danger); }
        .stat-label { color: #666; margin-top: 8px; font-size: 0.9em; }
        
        .data-card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 25px; }
        .card-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; } th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: var(--dark); } tr:hover { background: #f8f9fa; }
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; } .badge-warning { background: #fff3cd; color: #856404; } .badge-danger { background: #f8d7da; color: #721c24; } .badge-primary { background: #d1ecf1; color: #0c5460; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: var(--radius); box-shadow: var(--shadow); width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; } .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--secondary); }
        
        /* Styles sp√©cifiques pour les classes */
        .classes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .class-card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; transition: transform 0.3s; }
        .class-card:hover { transform: translateY(-5px); }
        .class-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .class-title { font-size: 1.2em; font-weight: 600; color: var(--primary); }
        .class-option { color: #666; font-size: 0.9em; }
        .class-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .class-stat { text-align: center; padding: 10px; background: #f8f9fa; border-radius: 6px; }
        .class-stat-number { font-size: 1.5em; font-weight: bold; color: var(--secondary); }
        .class-stat-label { font-size: 0.8em; color: #666; }
        .class-actions { display: flex; gap: 8px; margin-top: 15px; }
        
        @media (max-width: 768px) { 
            .sidebar { transform: translateX(-100%); } 
            .main-content { margin-left: 0; } 
            .form-row { grid-template-columns: 1fr; } 
            .search-bar { flex-direction: column; }
            .classes-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="logosaintcharles.JPG" alt="Logo">
                <h3>Saint Charles Lwanga</h3>
                <p style="opacity: 0.8; font-size: 0.9em;">Kolwezi</p>
            </div>

            <div class="user-info">
                <img id="userAvatar" class="user-avatar" src="" alt="Utilisateur">
                <div>
                    <div id="userName" style="font-weight: 600;">Chargement...</div>
                    <div id="userRole" style="font-size: 0.8em; opacity: 0.8;">Chargement...</div>
                </div>
            </div>

            <div class="sidebar-menu">
                <div class="menu-item" onclick="window.location.href='dashboard.html'">üìä Tableau de Bord</div>
                <div class="menu-item" onclick="window.location.href='eleves.html'">üë®‚Äçüéì √âl√®ves</div>
                <div class="menu-item" onclick="window.location.href='enseignants.html'">üë®‚Äçüè´ Enseignants</div>
                <div class="menu-item active">üè´ Classes</div>
                <div class="menu-item" onclick="showNotification('Module notes - En d√©veloppement')">üìù Notes</div>
                <div class="menu-item" onclick="logout()" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #34495e;">üö™ D√©connexion</div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="top-header">
                <h2>Gestion des Classes</h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="currentDate" style="color: #666;"></span>
                    <span id="userBadge" class="badge badge-success">CHARGEMENT</span>
                </div>
            </div>

            <div class="content-area">
                <!-- EN-T√äTE -->
                <div class="page-header">
                    <div>
                        <h1 style="margin-bottom: 5px;">Gestion des Classes</h1>
                        <p style="color: #666;">Organisation des classes, options et effectifs</p>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="exportClasses()">üìä Exporter</button>
                        <button class="btn btn-success" onclick="showAddClasseModal()">‚ûï Nouvelle Classe</button>
                    </div>
                </div>

                <!-- BARRE DE RECHERCHE -->
                <div class="search-bar">
                    <input type="text" id="searchClasses" placeholder="Rechercher une classe..." style="flex: 1;">
                    <select id="filterNiveau">
                        <option value="">Tous les niveaux</option>
                        <option value="7√®me">7√®me</option>
                        <option value="8√®me">8√®me</option>
                        <option value="1√®re">1√®re</option>
                        <option value="2√®me">2√®me</option>
                        <option value="3√®me">3√®me</option>
                        <option value="4√®me">4√®me</option>
                    </select>
                    <select id="filterOption">
                        <option value="">Toutes les options</option>
                        <option value="EB">√âcole de Base</option>
                        <option value="P√©dagogie">P√©dagogie G√©n√©rale</option>
                        <option value="Commerciale">Commerciale et Gestion</option>
                        <option value="Scientifique">Scientifique</option>
                        <option value="Agronomie">Agronomie</option>
                    </select>
                    <button class="btn btn-primary" onclick="searchClasses()">üîç Rechercher</button>
                </div>

                <!-- STATISTIQUES -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalClassesCount">0</div>
                        <div class="stat-label">Classes total</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number" id="totalElevesClasses">0</div>
                        <div class="stat-label">√âl√®ves total</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number" id="moyenneEffectif">0</div>
                        <div class="stat-label">Moyenne par classe</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-number" id="classesPleine">0</div>
                        <div class="stat-label">Classes pleines</div>
                    </div>
                </div>

                <!-- VUE CARTES DES CLASSES -->
                <div class="data-card">
                    <div class="card-header">
                        <h3>Vue d'ensemble des Classes</h3>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="toggleView()">
                                <span id="viewToggleText">üìã Vue Tableau</span>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="loadClassesFromFirebase()">
                                üîÑ Actualiser
                            </button>
                        </div>
                    </div>
                    <div id="classesGridView">
                        <div class="classes-grid" id="classesGrid">
                            <!-- Cartes des classes charg√©es dynamiquement -->
                        </div>
                    </div>
                    <div id="classesTableView" style="display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom Classe</th>
                                    <th>Niveau</th>
                                    <th>Option</th>
                                    <th>Effectif</th>
                                    <th>Professeur Principal</th>
                                    <th>Salle</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="classesTable">
                                <!-- Tableau des classes charg√© dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AJOUT CLASSE -->
    <div id="addClasseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nouvelle Classe</h3>
                <button onclick="closeModal('addClasseModal')" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úñ</button>
            </div>
            <div class="modal-body">
                <form id="addClasseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="classeNom">Nom de la Classe *</label>
                            <input type="text" id="classeNom" required placeholder="4√®me Scientifique">
                        </div>
                        <div class="form-group">
                            <label for="classeCode">Code Classe *</label>
                            <input type="text" id="classeCode" required placeholder="4SC2024">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="classeNiveau">Niveau *</label>
                            <select id="classeNiveau" required>
                                <option value="">Choisir le niveau</option>
                                <option value="7√®me">7√®me</option>
                                <option value="8√®me">8√®me</option>
                                <option value="1√®re">1√®re</option>
                                <option value="2√®me">2√®me</option>
                                <option value="3√®me">3√®me</option>
                                <option value="4√®me">4√®me</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="classeOption">Option *</label>
                            <select id="classeOption" required>
                                <option value="">Choisir l'option</option>
                                <option value="EB">√âcole de Base</option>
                                <option value="P√©dagogie">P√©dagogie G√©n√©rale</option>
                                <option value="Commerciale">Commerciale et Gestion</option>
                                <option value="Scientifique">Scientifique</option>
                                <option value="Agronomie">Agronomie</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="classeSalle">Salle *</label>
                            <input type="text" id="classeSalle" required placeholder="Salle 101">
                        </div>
                        <div class="form-group">
                            <label for="classeEffectifMax">Effectif Maximum</label>
                            <input type="number" id="classeEffectifMax" placeholder="40" value="40">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="classeProfesseurPrincipal">Professeur Principal</label>
                            <select id="classeProfesseurPrincipal">
                                <option value="">Choisir un professeur</option>
                                <!-- Charg√© dynamiquement depuis Firebase -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="classeStatut">Statut *</label>
                            <select id="classeStatut" required>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Archive">Archiv√©e</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="classeDescription">Description</label>
                        <textarea id="classeDescription" rows="3" placeholder="Description de la classe..."></textarea>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('addClasseModal')">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-success" style="flex: 1;">
                            üíæ Cr√©er la Classe
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // === CONFIGURATION FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyDTM4gdOs_Ud3DC49pmammYMlDH3cSSgZs",
            authDomain: "gestion-scolaire-st-charles.firebaseapp.com",
            projectId: "gestion-scolaire-st-charles",
            storageBucket: "gestion-scolaire-st-charles.firebasestorage.app",
            messagingSenderId: "1033368821503",
            appId: "1:1033368821503:web:a4ba1c8d439193c5f336ca"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // === DONN√âES DES CLASSES ===
        let classes = [];
        let filteredClasses = [];
        let enseignants = [];
        let eleves = [];
        let currentView = 'grid';

        // === CHARGEMENT DEPUIS FIREBASE ===
        async function loadClassesFromFirebase() {
            try {
                console.log('üîÑ Chargement des classes depuis Firebase...');
                
                // Charger les classes
                const classesSnapshot = await db.collection('classes').orderBy('niveau').orderBy('nom').get();
                classes = [];
                
                classesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    classes.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Charger les enseignants pour les professeurs principaux
                const enseignantsSnapshot = await db.collection('enseignants').where('statut', '==', 'Actif').get();
                enseignants = [];
                enseignantsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    enseignants.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Charger les √©l√®ves pour calculer les effectifs
                const elevesSnapshot = await db.collection('eleves').where('statut', '==', 'Actif').get();
                eleves = [];
                elevesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    eleves.push({
                        id: doc.id,
                        ...data
                    });
                });

                console.log(`‚úÖ ${classes.length} classes charg√©es depuis Firebase`);
                console.log(`‚úÖ ${enseignants.length} enseignants charg√©s`);
                console.log(`‚úÖ ${eleves.length} √©l√®ves charg√©s`);
                
                // Si pas de classes, cr√©er des donn√©es de d√©mo
                if (classes.length === 0) {
                    await createDemoClasses();
                } else {
                    // Calculer les effectifs r√©els
                    await calculateEffectifsReels();
                    filteredClasses = [...classes];
                    updateClassesDisplay();
                    updateClassesStats();
                    populateEnseignantsSelect();
                }

            } catch (error) {
                console.error('‚ùå Erreur Firebase:', error);
                showNotification('Erreur de chargement des donn√©es', 'error');
            }
        }

        // === CALCUL DES EFFECTIFS R√âELS ===
        async function calculateEffectifsReels() {
            classes.forEach(classe => {
                const effectifReel = eleves.filter(eleve => eleve.classe === classe.nom).length;
                classe.effectifReel = effectifReel;
                classe.tauxRemplissage = Math.round((effectifReel / (classe.effectifMax || 40)) * 100);
            });
        }

        // === CR√âATION DE DONN√âES DE D√âMO ===
        async function createDemoClasses() {
            const demoClasses = [
                {
                    nom: "7√®me EB",
                    code: "7EB2024",
                    niveau: "7√®me",
                    option: "EB",
                    salle: "Salle 101",
                    effectifMax: 45,
                    professeurPrincipal: "",
                    statut: "Active",
                    description: "Classe de 7√®me √âcole de Base"
                },
                {
                    nom: "8√®me EB", 
                    code: "8EB2024",
                    niveau: "8√®me",
                    option: "EB",
                    salle: "Salle 102",
                    effectifMax: 42,
                    professeurPrincipal: "",
                    statut: "Active",
                    description: "Classe de 8√®me √âcole de Base"
                },
                {
                    nom: "1√®re P√©dagogie",
                    code: "1PED2024",
                    niveau: "1√®re",
                    option: "P√©dagogie",
                    salle: "Salle 201",
                    effectifMax: 38,
                    professeurPrincipal: "",
                    statut: "Active",
                    description: "Classe de 1√®re P√©dagogie G√©n√©rale"
                },
                {
                    nom: "2√®me P√©dagogie",
                    code: "2PED2024",
                    niveau: "2√®me",
                    option: "P√©dagogie",
                    salle: "Salle 202",
                    effectifMax: 35,
                    professeurPrincipal: "",
                    statut: "Active",
                    description: "Classe de 2√®me P√©dagogie G√©n√©rale"
                },
                {
                    nom: "3√®me Commerciale",
                    code: "3COM2024",
                    niveau: "3√®me",
                    option: "Commerciale",
                    salle: "Salle 301",
                    effectifMax: 40,
                    professeurPrincipal: "",
                    statut: "Active",
                    description: "Classe de 3√®me Commerciale et Gestion"
                },
                {
                    nom: "4√®me Scientifique",
                    code: "4SCI2024",
                    niveau: "4√®me",
                    option: "Scientifique",
                    salle: "Salle 302",
                    effectifMax: 32,
                    professeurPrincipal: "",
                    statut: "Active",
                    description: "Classe de 4√®me Scientifique"
                },
                {
                    nom: "1√®re Agronomie",
                    code: "1AGR2024",
                    niveau: "1√®re",
                    option: "Agronomie",
                    salle: "Salle 401",
                    effectifMax: 28,
                    professeurPrincipal: "",
                    statut: "Active",
                    description: "Classe de 1√®re Agronomie"
                }
            ];

            try {
                const batch = db.batch();
                
                demoClasses.forEach(classe => {
                    const docRef = db.collection('classes').doc();
                    batch.set(docRef, {
                        ...classe,
                        dateCreation: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: 'system'
                    });
                });

                await batch.commit();
                console.log('‚úÖ Donn√©es de d√©mo cr√©√©es dans Firebase');
                await loadClassesFromFirebase();
                
            } catch (error) {
                console.error('‚ùå Erreur cr√©ation donn√©es d√©mo:', error);
            }
        }

        // === SAUVEGARDE D'UNE NOUVELLE CLASSE ===
        async function saveClasseToFirebase(classeData) {
            try {
                const docRef = await db.collection('classes').add({
                    ...classeData,
                    dateCreation: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: JSON.parse(localStorage.getItem('currentUser')).email
                });

                console.log('‚úÖ Classe sauvegard√©e avec ID:', docRef.id);
                return docRef.id;
                
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde:', error);
                throw error;
            }
        }

        // === MISE √Ä JOUR DE L'AFFICHAGE ===
        function updateClassesDisplay() {
            if (currentView === 'grid') {
                updateClassesGridView();
            } else {
                updateClassesTableView();
            }
        }

        function updateClassesGridView() {
            const grid = document.getElementById('classesGrid');
            
            if (filteredClasses.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        Aucune classe trouv√©e
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredClasses.map(classe => `
                <div class="class-card">
                    <div class="class-header">
                        <div>
                            <div class="class-title">${classe.nom}</div>
                            <div class="class-option">${classe.option} ‚Ä¢ ${classe.salle}</div>
                        </div>
                        <span class="badge ${getStatutBadgeClass(classe.statut)}">${classe.statut}</span>
                    </div>
                    
                    <div class="class-stats">
                        <div class="class-stat">
                            <div class="class-stat-number">${classe.effectifReel || 0}</div>
                            <div class="class-stat-label">√âl√®ves</div>
                        </div>
                        <div class="class-stat">
                            <div class="class-stat-number">${classe.effectifMax}</div>
                            <div class="class-stat-label">Max</div>
                        </div>
                    </div>

                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Taux de remplissage:</span>
                            <span><strong>${classe.tauxRemplissage || 0}%</strong></span>
                        </div>
                        <div style="background: #e0e0e0; border-radius: 10px; height: 8px;">
                            <div style="background: ${getProgressBarColor(classe.tauxRemplissage)}; width: ${classe.tauxRemplissage || 0}%; height: 100%; border-radius: 10px;"></div>
                        </div>
                    </div>

                    ${classe.professeurPrincipal ? `
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                        üë®‚Äçüè´ ${classe.professeurPrincipal}
                    </div>
                    ` : ''}

                    <div class="class-actions">
                        <button class="btn btn-sm btn-primary" onclick="viewClasse('${classe.id}')">
                            üëÅÔ∏è Voir
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="editClasse('${classe.id}')">
                            ‚úèÔ∏è Modifier
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteClasse('${classe.id}')">
                            üóëÔ∏è Supprimer
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateClassesTableView() {
            const tbody = document.getElementById('classesTable');
            
            if (filteredClasses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            Aucune classe trouv√©e
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredClasses.map(classe => `
                <tr>
                    <td><strong>${classe.nom}</strong></td>
                    <td>${classe.niveau}</td>
                    <td>${classe.option}</td>
                    <td>
                        <div>${classe.effectifReel || 0} / ${classe.effectifMax}</div>
                        <div style="font-size: 0.8em; color: #666;">${classe.tauxRemplissage || 0}% rempli</div>
                    </td>
                    <td>${classe.professeurPrincipal || 'Non assign√©'}</td>
                    <td>${classe.salle}</td>
                    <td><span class="badge ${getStatutBadgeClass(classe.statut)}">${classe.statut}</span></td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-sm btn-primary" onclick="viewClasse('${classe.id}')">üëÅÔ∏è</button>
                            <button class="btn btn-sm btn-warning" onclick="editClasse('${classe.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteClasse('${classe.id}')">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateClassesStats() {
            const totalEleves = eleves.filter(e => e.statut === 'Actif').length;
            const classesPleine = classes.filter(c => (c.tauxRemplissage || 0) >= 90).length;
            const moyenneEffectif = classes.length > 0 ? Math.round(totalEleves / classes.length) : 0;

            document.getElementById('totalClassesCount').textContent = classes.length;
            document.getElementById('totalElevesClasses').textContent = totalEleves;
            document.getElementById('moyenneEffectif').textContent = moyenneEffectif;
            document.getElementById('classesPleine').textContent = classesPleine;
        }

        // === FONCTIONS DE RECHERCHE ===
        function searchClasses() {
            const searchTerm = document.getElementById('searchClasses').value.toLowerCase();
            const niveauFilter = document.getElementById('filterNiveau').value;
            const optionFilter = document.getElementById('filterOption').value;

            filteredClasses = classes.filter(classe => {
                const matchesSearch = !searchTerm || 
                    classe.nom.toLowerCase().includes(searchTerm) ||
                    classe.code.toLowerCase().includes(searchTerm);
                
                const matchesNiveau = !niveauFilter || classe.niveau === niveauFilter;
                const matchesOption = !optionFilter || classe.option === optionFilter;

                return matchesSearch && matchesNiveau && matchesOption;
            });

            updateClassesDisplay();
        }

        // === GESTION MODAL ===
        function showAddClasseModal() {
            document.getElementById('addClasseForm').reset();
            populateEnseignantsSelect();
            document.getElementById('addClasseModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function populateEnseignantsSelect() {
            const select = document.getElementById('classeProfesseurPrincipal');
            select.innerHTML = '<option value="">Choisir un professeur</option>' +
                enseignants.map(enseignant => 
                    `<option value="${enseignant.nom} ${enseignant.prenom}">${enseignant.nom} ${enseignant.prenom} - ${enseignant.matiere}</option>`
                ).join('');
        }

        // === GESTION FORMULAIRE ===
        document.getElementById('addClasseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const classeData = {
                nom: document.getElementById('classeNom').value,
                code: document.getElementById('classeCode').value,
                niveau: document.getElementById('classeNiveau').value,
                option: document.getElementById('classeOption').value,
                salle: document.getElementById('classeSalle').value,
                effectifMax: parseInt(document.getElementById('classeEffectifMax').value) || 40,
                professeurPrincipal: document.getElementById('classeProfesseurPrincipal').value,
                statut: document.getElementById('classeStatut').value,
                description: document.getElementById('classeDescription').value
            };

            try {
                // Sauvegarde dans Firebase
                const classeId = await saveClasseToFirebase(classeData);
                
                // Ajouter √† la liste locale
                classes.unshift({
                    id: classeId,
                    ...classeData,
                    effectifReel: 0,
                    tauxRemplissage: 0
                });
                filteredClasses = [...classes];

                updateClassesDisplay();
                updateClassesStats();
                closeModal('addClasseModal');
                showNotification('Classe cr√©√©e avec succ√®s!', 'success');
                
            } catch (error) {
                showNotification('Erreur lors de la cr√©ation', 'error');
            }
        });

        // === ACTIONS SUR CLASSES ===
        function viewClasse(classeId) {
            const classe = classes.find(c => c.id === classeId);
            const elevesClasse = eleves.filter(e => e.classe === classe.nom);
            
            const message = `
D√©tails de la classe:

üè´ Nom: ${classe.nom}
üìã Code: ${classe.code}
üéØ Niveau: ${classe.niveau}
üìö Option: ${classe.option}
üö™ Salle: ${classe.salle}
üë• Effectif: ${elevesClasse.length} / ${classe.effectifMax} √©l√®ves
üìä Taux remplissage: ${classe.tauxRemplissage || 0}%
üë®‚Äçüè´ Professeur principal: ${classe.professeurPrincipal || 'Non assign√©'}
üìù Statut: ${classe.statut}

${classe.description ? `üìã Description: ${classe.description}` : ''}
            `;
            alert(message);
        }

        function editClasse(classeId) {
            showNotification(`Modification de la classe ${classeId} - Fonctionnalit√© en d√©veloppement`, 'info');
        }

        async function deleteClasse(classeId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette classe ? Cette action est irr√©versible.')) {
                try {
                    await db.collection('classes').doc(classeId).delete();
                    
                    classes = classes.filter(c => c.id !== classeId);
                    filteredClasses = filteredClasses.filter(c => c.id !== classeId);
                    
                    updateClassesDisplay();
                    updateClassesStats();
                    showNotification('Classe supprim√©e avec succ√®s', 'success');
                    
                } catch (error) {
                    showNotification('Erreur lors de la suppression', 'error');
                }
            }
        }

        function toggleView() {
            if (currentView === 'grid') {
                currentView = 'table';
                document.getElementById('classesGridView').style.display = 'none';
                document.getElementById('classesTableView').style.display = 'block';
                document.getElementById('viewToggleText').textContent = 'üîÑ Vue Cartes';
                updateClassesTableView();
            } else {
                currentView = 'grid';
                document.getElementById('classesGridView').style.display = 'block';
                document.getElementById('classesTableView').style.display = 'none';
                document.getElementById('viewToggleText').textContent = 'üìã Vue Tableau';
                updateClassesGridView();
            }
        }

        function exportClasses() {
            showNotification('Exportation des donn√©es en cours...', 'info');
            setTimeout(() => {
                showNotification('Donn√©es export√©es avec succ√®s!', 'success');
            }, 1500);
        }

        // === FONCTIONS UTILITAIRES ===
        function getStatutBadgeClass(statut) {
            const classes = {
                'Active': 'badge-success',
                'Inactive': 'badge-warning',
                'Archive': 'badge-primary'
            };
            return classes[statut] || 'badge-info';
        }

        function getProgressBarColor(taux) {
            if (taux >= 90) return var('--danger');
            if (taux >= 70) return var('--warning');
            return var('--success');
        }

        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--secondary)'};
                color: white;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // === INITIALISATION ===
        document.addEventListener('DOMContentLoaded', async function() {
            // V√©rifier la connexion
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Charger les donn√©es
            loadUserInfo();
            await loadClassesFromFirebase();
            updateDate();

            // CSS pour animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            console.log('üè´ Module classes charg√© avec Firebase');
        });

        function loadUserInfo() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.nom;
                document.getElementById('userRole').textContent = getRoleLabel(currentUser.role);
                document.getElementById('userBadge').textContent = getRoleBadge(currentUser.role);
                document.getElementById('userBadge').className = `badge ${getRoleBadgeClass(currentUser.role)}`;
                
                if (currentUser.photo) {
                    document.getElementById('userAvatar').src = currentUser.photo;
                }
            }
        }

        function updateDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
        }

        function getRoleLabel(role) {
            const roles = {
                'prefet': 'Pr√©fet des √âtudes',
                'directeur_etudes': 'Directeur des √âtudes',
                'directeur_discipline': 'Directeur de Discipline',
                'econome': '√âconome',
                'secretaire': 'Secr√©taire',
                'enseignant': 'Enseignant',
                'eleve': '√âl√®ve'
            };
            return roles[role] || 'Utilisateur';
        }

        function getRoleBadge(role) {
            const badges = {
                'prefet': 'PR√âFET',
                'directeur_etudes': 'DIRECTEUR',
                'directeur_discipline': 'DISCIPLINE', 
                'econome': '√âCONOME',
                'secretaire': 'SECR√âTAIRE',
                'enseignant': 'ENSEIGNANT',
                'eleve': '√âL√àVE'
            };
            return badges[role] || 'USER';
        }

        function getRoleBadgeClass(role) {
            const classes = {
                'prefet': 'badge-danger',
                'directeur_etudes': 'badge-primary',
                'directeur_discipline': 'badge-warning',
                'econome': 'badge-success',
                'secretaire': 'badge-info',
                'enseignant': 'badge-primary',
                'eleve': 'badge-success'
            };
            return classes[role] || 'badge-info';
        }
    </script>
</body>
</html>
