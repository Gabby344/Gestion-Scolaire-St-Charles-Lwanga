<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Financi√®re - Institut Saint Charles Lwanga</title>
    <style>
        /* STYLES EXISTANTS... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { 
            --primary: #2c3e50; --secondary: #3498db; --success: #27ae60; 
            --warning: #f39c12; --danger: #e74c3c; --purple: #9b59b6;
            --shadow: 0 4px 6px rgba(0,0,0,0.1); --radius: 10px; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; min-height: 100vh; color: #333; }
        
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--primary); color: white; position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-header { padding: 25px 20px; text-align: center; border-bottom: 1px solid #34495e; background: rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; padding: 15px 20px; background: rgba(0,0,0,0.2); margin: 10px; border-radius: 8px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .sidebar-menu { padding: 20px 0; }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.3s; border-left: 4px solid transparent; }
        .menu-item:hover { background: #34495e; border-left-color: var(--secondary); }
        .menu-item.active { background: var(--secondary); border-left-color: white; }
        
        .main-content { margin-left: 280px; flex: 1; }
        .top-header { background: white; padding: 0 30px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .content-area { padding: 30px; background: #f8f9fa; min-height: calc(100vh - 70px); }
        .page-header { background: white; padding: 25px 30px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        
        .search-bar { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .search-bar input, .search-bar select { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-width: 200px; }
        .action-buttons { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--secondary); color: white; } 
        .btn-success { background: var(--success); color: white; } 
        .btn-danger { background: var(--danger); color: white; } 
        .btn-warning { background: var(--warning); color: white; }
        .btn-purple { background: var(--purple); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; } 
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; border-top: 4px solid var(--secondary); }
        .stat-card.success { border-top-color: var(--success); } 
        .stat-card.warning { border-top-color: var(--warning); } 
        .stat-card.danger { border-top-color: var(--danger); }
        .stat-card.purple { border-top-color: var(--purple); }
        .stat-number { font-size: 2.5em; font-weight: bold; color: var(--secondary); display: block; }
        .stat-card.success .stat-number { color: var(--success); } 
        .stat-card.warning .stat-number { color: var(--warning); } 
        .stat-card.danger .stat-number { color: var(--danger); }
        .stat-card.purple .stat-number { color: var(--purple); }
        .stat-label { color: #666; margin-top: 8px; font-size: 0.9em; }
        
        .data-card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 25px; }
        .card-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; } 
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: var(--dark); } 
        tr:hover { background: #f8f9fa; }
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; } 
        .badge-warning { background: #fff3cd; color: #856404; } 
        .badge-danger { background: #f8d7da; color: #721c24; } 
        .badge-primary { background: #d1ecf1; color: #0c5460; }
        .badge-purple { background: #e8dff5; color: #4a2c6d; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: var(--radius); box-shadow: var(--shadow); width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; } 
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; } 
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--secondary); }
        
        /* Styles sp√©cifiques finances */
        .tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; }
        .tab { padding: 12px 24px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab.active { border-bottom-color: var(--secondary); color: var(--secondary); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .finance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .finance-card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; }
        .finance-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .finance-card-title { font-size: 1.2em; font-weight: 600; color: var(--primary); }
        .finance-card-amount { font-size: 1.5em; font-weight: bold; }
        .finance-card-success { color: var(--success); }
        .finance-card-danger { color: var(--danger); }
        .finance-card-warning { color: var(--warning); }
        
        .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-info { flex: 1; }
        .transaction-amount { font-weight: 600; }
        .transaction-positive { color: var(--success); }
        .transaction-negative { color: var(--danger); }
        
        .progress-bar { background: #e0e0e0; border-radius: 10px; height: 8px; margin: 10px 0; }
        .progress-fill { height: 100%; border-radius: 10px; }
        .progress-success { background: var(--success); }
        .progress-warning { background: var(--warning); }
        .progress-danger { background: var(--danger); }
        
        .chart-container { height: 300px; background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 25px; }
        
        /* Receipt styles */
        .receipt { background: white; padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); max-width: 400px; margin: 0 auto; }
        .receipt-header { text-align: center; border-bottom: 2px dashed #ddd; padding-bottom: 20px; margin-bottom: 20px; }
        .receipt-title { font-size: 1.5em; font-weight: bold; color: var(--primary); }
        .receipt-details { margin-bottom: 20px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .receipt-total { border-top: 2px solid #ddd; padding-top: 15px; margin-top: 15px; font-weight: bold; }
        
        @media (max-width: 768px) { 
            .sidebar { transform: translateX(-100%); } 
            .main-content { margin-left: 0; } 
            .form-row { grid-template-columns: 1fr; } 
            .search-bar { flex-direction: column; }
            .finance-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="logosaintcharles.JPG" alt="Logo">
                <h3>Saint Charles Lwanga</h3>
                <p style="opacity: 0.8; font-size: 0.9em;">Kolwezi</p>
            </div>

            <div class="user-info">
                <img id="userAvatar" class="user-avatar" src="" alt="Utilisateur">
                <div>
                    <div id="userName" style="font-weight: 600;">Chargement...</div>
                    <div id="userRole" style="font-size: 0.8em; opacity: 0.8;">Chargement...</div>
                </div>
            </div>

            <div class="sidebar-menu">
                <div class="menu-item" onclick="window.location.href='dashboard.html'">üìä Tableau de Bord</div>
                <div class="menu-item" onclick="window.location.href='eleves.html'">üë®‚Äçüéì √âl√®ves</div>
                <div class="menu-item" onclick="window.location.href='enseignants.html'">üë®‚Äçüè´ Enseignants</div>
                <div class="menu-item" onclick="window.location.href='classes.html'">üè´ Classes</div>
                <div class="menu-item" onclick="window.location.href='notes.html'">üìù Notes & Bulletins</div>
                <div class="menu-item active">üí∞ Gestion Financi√®re</div>
                <div class="menu-item" onclick="logout()" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #34495e;">üö™ D√©connexion</div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="top-header">
                <h2>Gestion Financi√®re</h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="currentDate" style="color: #666;"></span>
                    <span id="userBadge" class="badge badge-success">CHARGEMENT</span>
                </div>
            </div>

            <div class="content-area">
                <!-- EN-T√äTE -->
                <div class="page-header">
                    <div>
                        <h1 style="margin-bottom: 5px;">Gestion Financi√®re</h1>
                        <p style="color: #666;">Suivi des frais scolaires, paiements et tr√©sorerie</p>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="genererRapportFinancier()">üìä Rapport Financier</button>
                        <button class="btn btn-purple" onclick="showNouvelleTransactionModal()">‚ûï Nouvelle Transaction</button>
                        <button class="btn btn-success" onclick="showEnregistrerPaiementModal()">üí≥ Enregistrer Paiement</button>
                    </div>
                </div>

                <!-- TABS -->
                <div class="tabs">
                    <div class="tab active" data-tab="overview">üìà Vue d'ensemble</div>
                    <div class="tab" data-tab="paiements">üí≥ Paiements</div>
                    <div class="tab" data-tab="frais">üé´ Frais Scolaires</div>
                    <div class="tab" data-tab="rapports">üìä Rapports</div>
                </div>

                <!-- TAB VUE D'ENSEMBLE -->
                <div class="tab-content active" id="overview-tab">
                    <!-- STATISTIQUES FINANCI√àRES -->
                    <div class="stats-grid">
                        <div class="stat-card success">
                            <div class="stat-number" id="totalRecettes">0 $</div>
                            <div class="stat-label">Recettes Total</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-number" id="totalDepenses">0 $</div>
                            <div class="stat-label">D√©penses Total</div>
                        </div>
                        <div class="stat-card purple">
                            <div class="stat-number" id="soldeActuel">0 $</div>
                            <div class="stat-label">Solde Actuel</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-number" id="tauxEncaisse">0%</div>
                            <div class="stat-label">Taux d'Encaisse</div>
                        </div>
                    </div>

                    <!-- CARTES FINANCI√àRES -->
                    <div class="finance-grid">
                        <div class="finance-card">
                            <div class="finance-card-header">
                                <div class="finance-card-title">üìä Recettes du Mois</div>
                            </div>
                            <div class="finance-card-amount finance-card-success" id="recettesMois">0 $</div>
                            <div style="color: #666; margin-top: 10px;">vs mois dernier: <span id="evolutionRecettes" style="color: var(--success);">+0%</span></div>
                        </div>
                        
                        <div class="finance-card">
                            <div class="finance-card-header">
                                <div class="finance-card-title">üí∏ D√©penses du Mois</div>
                            </div>
                            <div class="finance-card-amount finance-card-danger" id="depensesMois">0 $</div>
                            <div style="color: #666; margin-top: 10px;">vs mois dernier: <span id="evolutionDepenses" style="color: var(--danger);">+0%</span></div>
                        </div>
                        
                        <div class="finance-card">
                            <div class="finance-card-header">
                                <div class="finance-card-title">‚ö†Ô∏è Impay√©s</div>
                            </div>
                            <div class="finance-card-amount finance-card-warning" id="totalImpayes">0 $</div>
                            <div style="color: #666; margin-top: 10px;"><span id="nombreImpayes">0</span> √©l√®ves concern√©s</div>
                        </div>
                    </div>

                    <!-- GRAPHIQUES ET DERNI√àRES TRANSACTIONS -->
                    <div class="data-card">
                        <div class="card-header">
                            <h3>√âvolution des Finances</h3>
                            <select id="periodeGraphique" onchange="updateFinancialCharts()">
                                <option value="3">3 derniers mois</option>
                                <option value="6">6 derniers mois</option>
                                <option value="12">12 derniers mois</option>
                            </select>
                        </div>
                        <div class="chart-container" id="financialChart">
                            <!-- Graphique sera g√©n√©r√© dynamiquement -->
                            <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #666;">
                                Chargement du graphique...
                            </div>
                        </div>
                    </div>

                    <div class="data-card">
                        <div class="card-header">
                            <h3>Derni√®res Transactions</h3>
                            <button class="btn btn-sm btn-primary" onclick="chargerTransactions()">üîÑ Actualiser</button>
                        </div>
                        <div id="listeTransactions">
                            <!-- Transactions charg√©es dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- TAB PAIEMENTS -->
                <div class="tab-content" id="paiements-tab">
                    <!-- BARRE DE RECHERCHE PAIEMENTS -->
                    <div class="search-bar">
                        <select id="filterClassePaiements">
                            <option value="">Toutes les classes</option>
                            <!-- Charg√© dynamiquement -->
                        </select>
                        <select id="filterStatutPaiement">
                            <option value="">Tous les statuts</option>
                            <option value="pay√©">Pay√©</option>
                            <option value="partiel">Partiel</option>
                            <option value="impay√©">Impay√©</option>
                        </select>
                        <input type="month" id="filterMoisPaiement" value="">
                        <button class="btn btn-primary" onclick="chargerPaiements()">üîç Rechercher</button>
                    </div>

                    <!-- TABLEAU DES PAIEMENTS -->
                    <div class="data-card">
                        <div class="card-header">
                            <h3>Suivi des Paiements</h3>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-success" onclick="exporterPaiementsExcel()">üìä Excel</button>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>√âl√®ve</th>
                                    <th>Classe</th>
                                    <th>Type Frais</th>
                                    <th>Montant</th>
                                    <th>Pay√©</th>
                                    <th>Reste</th>
                                    <th>Statut</th>
                                    <th>√âch√©ance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tableauPaiements">
                                <!-- Paiements charg√©s dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB FRAIS SCOLAIRES -->
                <div class="tab-content" id="frais-tab">
                    <div class="data-card">
                        <div class="card-header">
                            <h3>Configuration des Frais Scolaires</h3>
                            <button class="btn btn-success" onclick="showConfigurerFraisModal()">‚öôÔ∏è Configurer Frais</button>
                        </div>
                        <div id="configurationFrais">
                            <!-- Configuration des frais charg√©e dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- TAB RAPPORTS -->
                <div class="tab-content" id="rapports-tab">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="rapportRecettesAnnee">0 $</div>
                            <div class="stat-label">Recettes Ann√©e</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="rapportDepensesAnnee">0 $</div>
                            <div class="stat-label">D√©penses Ann√©e</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="rapportBenefice">0 $</div>
                            <div class="stat-label">B√©n√©fice Net</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="rapportTauxImpayes">0%</div>
                            <div class="stat-label">Taux d'Impay√©s</div>
                        </div>
                    </div>

                    <div class="data-card">
                        <div class="card-header">
                            <h3>Rapport Financier D√©taill√©</h3>
                            <div class="action-buttons">
                                <button class="btn btn-warning" onclick="genererPDFRapport()">üìÑ PDF</button>
                                <button class="btn btn-success" onclick="exporterRapportExcel()">üìä Excel</button>
                            </div>
                        </div>
                        <div id="contenuRapport">
                            <!-- Contenu du rapport g√©n√©r√© dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL NOUVELLE TRANSACTION -->
    <div id="nouvelleTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nouvelle Transaction</h3>
                <button onclick="closeModal('nouvelleTransactionModal')" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úñ</button>
            </div>
            <div class="modal-body">
                <form id="nouvelleTransactionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transactionType">Type de Transaction *</label>
                            <select id="transactionType" required>
                                <option value="">Choisir le type</option>
                                <option value="recette">Recette</option>
                                <option value="depense">D√©pense</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionCategorie">Cat√©gorie *</label>
                            <select id="transactionCategorie" required>
                                <option value="">Choisir la cat√©gorie</option>
                                <!-- Charg√© dynamiquement -->
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="transactionMontant">Montant ($) *</label>
                            <input type="number" id="transactionMontant" step="0.01" min="0" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="transactionDate">Date *</label>
                            <input type="date" id="transactionDate" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="transactionDescription">Description *</label>
                        <textarea id="transactionDescription" rows="3" required placeholder="Description de la transaction..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="transactionMoyenPaiement">Moyen de Paiement</label>
                            <select id="transactionMoyenPaiement">
                                <option value="cash">Esp√®ces</option>
                                <option value="mobile_money">Mobile Money</option>
                                <option value="virement">Virement Bancaire</option>
                                <option value="cheque">Ch√®que</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionReference">R√©f√©rence</label>
                            <input type="text" id="transactionReference" placeholder="Num√©ro de r√©f√©rence">
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('nouvelleTransactionModal')">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-success" style="flex: 1;">
                            üíæ Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL ENREGISTRER PAIEMENT -->
    <div id="enregistrerPaiementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Enregistrer un Paiement</h3>
                <button onclick="closeModal('enregistrerPaiementModal')" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úñ</button>
            </div>
            <div class="modal-body">
                <form id="enregistrerPaiementForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="paiementEleve">√âl√®ve *</label>
                            <select id="paiementEleve" required>
                                <option value="">Choisir un √©l√®ve</option>
                                <!-- Charg√© dynamiquement -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paiementTypeFrais">Type de Frais *</label>
                            <select id="paiementTypeFrais" required>
                                <option value="">Choisir le type</option>
                                <!-- Charg√© dynamiquement -->
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="paiementMontantDu">Montant d√ª ($)</label>
                            <input type="number" id="paiementMontantDu" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label for="paiementMontantPaye">Montant pay√© ($) *</label>
                            <input type="number" id="paiementMontantPaye" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="paiementDate">Date de paiement *</label>
                            <input type="date" id="paiementDate" required>
                        </div>
                        <div class="form-group">
                            <label for="paiementMoyen">Moyen de paiement *</label>
                            <select id="paiementMoyen" required>
                                <option value="cash">Esp√®ces</option>
                                <option value="mobile_money">Mobile Money</option>
                                <option value="virement">Virement Bancaire</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="paiementReference">R√©f√©rence du paiement</label>
                        <input type="text" id="paiementReference" placeholder="Num√©ro de transaction...">
                    </div>

                    <div class="form-group">
                        <label for="paiementNotes">Notes</label>
                        <textarea id="paiementNotes" rows="2" placeholder="Notes suppl√©mentaires..."></textarea>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('enregistrerPaiementModal')">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-success" style="flex: 1;">
                            üí≥ Enregistrer Paiement
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIGURER FRAIS -->
    <div id="configurerFraisModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configuration des Frais Scolaires</h3>
                <button onclick="closeModal('configurerFraisModal')" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úñ</button>
            </div>
            <div class="modal-body">
                <form id="configurerFraisForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fraisAnneeScolaire">Ann√©e Scolaire *</label>
                            <select id="fraisAnneeScolaire" required>
                                <option value="2024-2025">2024-2025</option>
                                <option value="2025-2026">2025-2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fraisClasse">Classe *</label>
                            <select id="fraisClasse" required>
                                <option value="">Choisir une classe</option>
                                <!-- Charg√© dynamiquement -->
                            </select>
                        </div>
                    </div>

                    <h4 style="margin: 20px 0 15px 0; border-bottom: 2px solid #eee; padding-bottom: 10px;">Frais Scolaires</h4>

                    <div id="listeFraisConfig">
                        <!-- Frais configur√©s dynamiquement -->
                    </div>

                    <button type="button" class="btn btn-sm btn-primary" onclick="ajouterLigneFrais()" style="margin-bottom: 20px;">
                        ‚ûï Ajouter un frais
                    </button>

                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('configurerFraisModal')">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-success" style="flex: 1;">
                            üíæ Sauvegarder Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // === CONFIGURATION FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyDTM4gdOs_Ud3DC49pmammYMlDH3cSSgZs",
            authDomain: "gestion-scolaire-st-charles.firebaseapp.com",
            projectId: "gestion-scolaire-st-charles",
            storageBucket: "gestion-scolaire-st-charles.firebasestorage.app",
            messagingSenderId: "1033368821503",
            appId: "1:1033368821503:web:a4ba1c8d439193c5f336ca"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // === DONN√âES ===
        let transactions = [];
        let paiements = [];
        let fraisScolaires = [];
        let eleves = [];
        let classes = [];
        let categories = [];

        // === CAT√âGORIES PR√âD√âFINIES ===
        const categoriesPredefinies = {
            recette: [
                'Frais de scolarit√©',
                'Frais d\'inscription',
                'Frais de cantine',
                'Frais de transport',
                'Frais divers',
                'Dons',
                'Subventions'
            ],
            depense: [
                'Salaires enseignants',
                'Salaires administratifs',
                'Loyer',
                '√âlectricit√©',
                'Eau',
                'Internet',
                'Fournitures bureau',
                'Fournitures classe',
                'Entretien',
                '√âquipement',
                'Formation',
                'Autres d√©penses'
            ]
        };

        // === CHARGEMENT DES DONN√âES ===
        async function loadFinancialData() {
            try {
                console.log('üîÑ Chargement des donn√©es financi√®res...');
                
                // Charger les transactions
                const transactionsSnapshot = await db.collection('transactions')
                    .orderBy('date', 'desc')
                    .limit(100)
                    .get();
                transactions = [];
                transactionsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    transactions.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Charger les paiements
                const paiementsSnapshot = await db.collection('paiements')
                    .orderBy('datePaiement', 'desc')
                    .get();
                paiements = [];
                paiementsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    paiements.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Charger les frais scolaires
                const fraisSnapshot = await db.collection('fraisScolaires').get();
                fraisScolaires = [];
                fraisSnapshot.forEach((doc) => {
                    const data = doc.data();
                    fraisScolaires.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Charger les √©l√®ves
                const elevesSnapshot = await db.collection('eleves').where('statut', '==', 'Actif').get();
                eleves = [];
                elevesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    eleves.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Charger les classes
                const classesSnapshot = await db.collection('classes').where('statut', '==', 'Active').get();
                classes = [];
                classesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    classes.push({
                        id: doc.id,
                        ...data
                    });
                });

                console.log(`‚úÖ ${transactions.length} transactions charg√©es`);
                console.log(`‚úÖ ${paiements.length} paiements charg√©s`);
                console.log(`‚úÖ ${fraisScolaires.length} configurations de frais charg√©es`);
                console.log(`‚úÖ ${eleves.length} √©l√®ves charg√©s`);
                console.log(`‚úÖ ${classes.length} classes charg√©es`);

                updateFinancialStats();
                populateSelects();
                updateTransactionsList();
                updatePaiementsTable();

            } catch (error) {
                console.error('‚ùå Erreur chargement donn√©es financi√®res:', error);
                showNotification('Erreur de chargement des donn√©es financi√®res', 'error');
            }
        }

        // === STATISTIQUES FINANCI√àRES ===
        function updateFinancialStats() {
            const maintenant = new Date();
            const moisActuel = maintenant.getMonth();
            const anneeActuelle = maintenant.getFullYear();

            // Calcul des totaux
            const totalRecettes = transactions
                .filter(t => t.type === 'recette')
                .reduce((sum, t) => sum + t.montant, 0);

            const totalDepenses = transactions
                .filter(t => t.type === 'depense')
                .reduce((sum, t) => sum + t.montant, 0);

            const soldeActuel = totalRecettes - totalDepenses;

            // Calcul du mois actuel
            const recettesMois = transactions
                .filter(t => t.type === 'recette' && isSameMonth(t.date, maintenant))
                .reduce((sum, t) => sum + t.montant, 0);

            const depensesMois = transactions
                .filter(t => t.type === 'depense' && isSameMonth(t.date, maintenant))
                .reduce((sum, t) => sum + t.montant, 0);

            // Calcul des impay√©s
            const totalImpayes = calculerTotalImpayes();
            const nombreImpayes = calculerNombreElevesImpayes();

            // Mise √† jour de l'interface
            document.getElementById('totalRecettes').textContent = formatCurrency(totalRecettes);
            document.getElementById('totalDepenses').textContent = formatCurrency(totalDepenses);
            document.getElementById('soldeActuel').textContent = formatCurrency(soldeActuel);
            document.getElementById('recettesMois').textContent = formatCurrency(recettesMois);
            document.getElementById('depensesMois').textContent = formatCurrency(depensesMois);
            document.getElementById('totalImpayes').textContent = formatCurrency(totalImpayes);
            document.getElementById('nombreImpayes').textContent = nombreImpayes;

            // Taux d'encaisse (simplifi√©)
            const tauxEncaisse = totalRecettes > 0 ? Math.round((recettesMois / totalRecettes) * 100) : 0;
            document.getElementById('tauxEncaisse').textContent = tauxEncaisse + '%';
        }

                function calculerTotalImpayes() {
            // Logique simplifi√©e pour calculer les impay√©s
            let total = 0;
            eleves.forEach(eleve => {
                const fraisEleve = fraisScolaires.find(f => f.classe === eleve.classe);
                if (fraisEleve) {
                    const totalDus = fraisEleve.frais.reduce((sum, f) => sum + f.montant, 0);
                    const totalPayes = paiements
                        .filter(p => p.eleveId === eleve.id)
                        .reduce((sum, p) => sum + p.montantPaye, 0);
                    
                    const impaye = Math.max(0, totalDus - totalPayes);
                    total += impaye;
                }
            });
            return total;
        }

        function calculerNombreElevesImpayes() {
            let count = 0;
            eleves.forEach(eleve => {
                const fraisEleve = fraisScolaires.find(f => f.classe === eleve.classe);
                if (fraisEleve) {
                    const totalDus = fraisEleve.frais.reduce((sum, f) => sum + f.montant, 0);
                    const totalPayes = paiements
                        .filter(p => p.eleveId === eleve.id)
                        .reduce((sum, p) => sum + p.montantPaye, 0);
                    
                    if (totalPayes < totalDus) {
                        count++;
                    }
                }
            });
            return count;
        }

        // === FONCTIONS UTILITAIRES ===
        function isSameMonth(dateString, referenceDate) {
            const date = new Date(dateString);
            return date.getMonth() === referenceDate.getMonth() && 
                   date.getFullYear() === referenceDate.getFullYear();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', { 
                style: 'currency', 
                currency: 'USD' 
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR');
        }

        // === REMPLISSAGE DES SELECTS ===
        function populateSelects() {
            // Select des classes
            const classSelects = [
                'filterClassePaiements', 'fraisClasse', 'paiementEleve'
            ];
            
            classSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Choisir une classe</option>' +
                        classes.map(classe => 
                            `<option value="${classe.id}">${classe.nom}</option>`
                        ).join('');
                }
            });

            // Select des √©l√®ves pour paiements
            const eleveSelect = document.getElementById('paiementEleve');
            if (eleveSelect) {
                eleveSelect.innerHTML = '<option value="">Choisir un √©l√®ve</option>' +
                    eleves.map(eleve => 
                        `<option value="${eleve.id}">${eleve.matricule} - ${eleve.nom} ${eleve.prenom} (${eleve.classe})</option>`
                    ).join('');
            }

            // Select des cat√©gories de transactions
            const categorieSelect = document.getElementById('transactionCategorie');
            if (categorieSelect) {
                let html = '<option value="">Choisir la cat√©gorie</option>';
                
                // Cat√©gories de recettes
                html += '<optgroup label="Recettes">';
                categoriesPredefinies.recette.forEach(cat => {
                    html += `<option value="recette:${cat}">${cat}</option>`;
                });
                html += '</optgroup>';
                
                // Cat√©gories de d√©penses
                html += '<optgroup label="D√©penses">';
                categoriesPredefinies.depense.forEach(cat => {
                    html += `<option value="depense:${cat}">${cat}</option>`;
                });
                html += '</optgroup>';
                
                categorieSelect.innerHTML = html;
            }
        }

        // === GESTION DES TABS ===
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // D√©sactiver tous les tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Activer le tab cliqu√©
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });

        // === GESTION DES MODALS ===
        function showNouvelleTransactionModal() {
            document.getElementById('nouvelleTransactionForm').reset();
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('nouvelleTransactionModal').style.display = 'flex';
        }

        function showEnregistrerPaiementModal() {
            document.getElementById('enregistrerPaiementForm').reset();
            document.getElementById('paiementDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('enregistrerPaiementModal').style.display = 'flex';
        }

        function showConfigurerFraisModal() {
            document.getElementById('configurerFraisForm').reset();
            document.getElementById('fraisAnneeScolaire').value = '2024-2025';
            document.getElementById('configurerFraisModal').style.display = 'flex';
            initialiserConfigurationFrais();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // === GESTION DES TRANSACTIONS ===
        document.getElementById('nouvelleTransactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const type = document.getElementById('transactionType').value;
            const [typeCat, categorie] = document.getElementById('transactionCategorie').value.split(':');
            const montant = parseFloat(document.getElementById('transactionMontant').value);
            const date = document.getElementById('transactionDate').value;
            const description = document.getElementById('transactionDescription').value;
            const moyenPaiement = document.getElementById('transactionMoyenPaiement').value;
            const reference = document.getElementById('transactionReference').value;

            try {
                const transactionData = {
                    type: typeCat,
                    categorie: categorie,
                    montant: montant,
                    date: date,
                    description: description,
                    moyenPaiement: moyenPaiement,
                    reference: reference,
                    dateCreation: new Date().toISOString(),
                    creePar: JSON.parse(localStorage.getItem('currentUser')).email
                };

                await db.collection('transactions').add(transactionData);
                
                showNotification('Transaction enregistr√©e avec succ√®s!', 'success');
                closeModal('nouvelleTransactionModal');
                await loadFinancialData();
                
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde transaction:', error);
                showNotification('Erreur lors de l\'enregistrement', 'error');
            }
        });

        // === GESTION DES PAIEMENTS ===
        document.getElementById('enregistrerPaiementForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const eleveId = document.getElementById('paiementEleve').value;
            const typeFrais = document.getElementById('paiementTypeFrais').value;
            const montantPaye = parseFloat(document.getElementById('paiementMontantPaye').value);
            const datePaiement = document.getElementById('paiementDate').value;
            const moyenPaiement = document.getElementById('paiementMoyen').value;
            const reference = document.getElementById('paiementReference').value;
            const notes = document.getElementById('paiementNotes').value;

            const eleve = eleves.find(e => e.id === eleveId);

            try {
                const paiementData = {
                    eleveId: eleveId,
                    eleveNom: `${eleve.nom} ${eleve.prenom}`,
                    eleveMatricule: eleve.matricule,
                    eleveClasse: eleve.classe,
                    typeFrais: typeFrais,
                    montantPaye: montantPaye,
                    datePaiement: datePaiement,
                    moyenPaiement: moyenPaiement,
                    reference: reference,
                    notes: notes,
                    anneeScolaire: '2024-2025',
                    dateCreation: new Date().toISOString(),
                    creePar: JSON.parse(localStorage.getItem('currentUser')).email
                };

                await db.collection('paiements').add(paiementData);
                
                showNotification('Paiement enregistr√© avec succ√®s!', 'success');
                closeModal('enregistrerPaiementModal');
                await loadFinancialData();
                
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde paiement:', error);
                showNotification('Erreur lors de l\'enregistrement', 'error');
            }
        });

        // === CONFIGURATION DES FRAIS ===
        function initialiserConfigurationFrais() {
            const container = document.getElementById('listeFraisConfig');
            container.innerHTML = `
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>Nom du frais</label>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Montant ($)</label>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Actions</label>
                    </div>
                </div>
                <div class="form-row frais-item">
                    <div class="form-group" style="flex: 2;">
                        <input type="text" class="frais-nom" value="Frais de scolarit√©" placeholder="Nom du frais">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <input type="number" class="frais-montant" value="150" step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <button type="button" class="btn btn-sm btn-danger" onclick="supprimerLigneFrais(this)">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }

        function ajouterLigneFrais() {
            const container = document.getElementById('listeFraisConfig');
            const nouvelleLigne = document.createElement('div');
            nouvelleLigne.className = 'form-row frais-item';
            nouvelleLigne.innerHTML = `
                <div class="form-group" style="flex: 2;">
                    <input type="text" class="frais-nom" placeholder="Nom du frais">
                </div>
                <div class="form-group" style="flex: 1;">
                    <input type="number" class="frais-montant" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group" style="flex: 1;">
                    <button type="button" class="btn btn-sm btn-danger" onclick="supprimerLigneFrais(this)">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(nouvelleLigne);
        }

        function supprimerLigneFrais(bouton) {
            const ligne = bouton.closest('.frais-item');
            if (ligne) {
                ligne.remove();
            }
        }

        document.getElementById('configurerFraisForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const anneeScolaire = document.getElementById('fraisAnneeScolaire').value;
            const classeId = document.getElementById('fraisClasse').value;
            const classe = classes.find(c => c.id === classeId);

            const fraisItems = document.querySelectorAll('.frais-item');
            const frais = [];

            fraisItems.forEach(item => {
                const nom = item.querySelector('.frais-nom').value;
                const montant = parseFloat(item.querySelector('.frais-montant').value);
                
                if (nom && !isNaN(montant)) {
                    frais.push({ nom, montant });
                }
            });

            try {
                const fraisData = {
                    anneeScolaire: anneeScolaire,
                    classe: classe.nom,
                    frais: frais,
                    dateCreation: new Date().toISOString(),
                    creePar: JSON.parse(localStorage.getItem('currentUser')).email
                };

                // V√©rifier si configuration existe d√©j√†
                const existingConfig = fraisScolaires.find(f => 
                    f.classe === classe.nom && f.anneeScolaire === anneeScolaire
                );

                if (existingConfig) {
                    await db.collection('fraisScolaires').doc(existingConfig.id).update(fraisData);
                } else {
                    await db.collection('fraisScolaires').add(fraisData);
                }

                showNotification('Configuration des frais sauvegard√©e!', 'success');
                closeModal('configurerFraisModal');
                await loadFinancialData();
                
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde frais:', error);
                showNotification('Erreur lors de la sauvegarde', 'error');
            }
        });

        // === MISE √Ä JOUR DES LISTES ===
        function updateTransactionsList() {
            const container = document.getElementById('listeTransactions');
            const recentTransactions = transactions.slice(0, 10);

            if (recentTransactions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Aucune transaction r√©cente
                    </div>
                `;
                return;
            }

            let html = '';
            recentTransactions.forEach(transaction => {
                const isRecette = transaction.type === 'recette';
                html += `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div style="font-weight: 600;">${transaction.description}</div>
                            <div style="font-size: 0.8em; color: #666;">
                                ${formatDate(transaction.date)} ‚Ä¢ ${transaction.categorie}
                                ${transaction.reference ? `‚Ä¢ Ref: ${transaction.reference}` : ''}
                            </div>
                        </div>
                        <div class="transaction-amount ${isRecette ? 'transaction-positive' : 'transaction-negative'}">
                            ${isRecette ? '+' : '-'}${formatCurrency(transaction.montant)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updatePaiementsTable() {
            const tbody = document.getElementById('tableauPaiements');
            const paiementsFiltres = filtrerPaiements();

            if (paiementsFiltres.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #666;">
                            Aucun paiement trouv√©
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            paiementsFiltres.forEach(paiement => {
                const fraisClasse = fraisScolaires.find(f => f.classe === paiement.eleveClasse);
                const totalDus = fraisClasse ? fraisClasse.frais.reduce((sum, f) => sum + f.montant, 0) : 0;
                const totalPayes = paiements
                    .filter(p => p.eleveId === paiement.eleveId && p.anneeScolaire === '2024-2025')
                    .reduce((sum, p) => sum + p.montantPaye, 0);
                const reste = Math.max(0, totalDus - totalPayes);
                
                let statut = 'pay√©';
                let badgeClass = 'badge-success';
                
                if (reste > 0) {
                    statut = totalPayes > 0 ? 'partiel' : 'impay√©';
                    badgeClass = totalPayes > 0 ? 'badge-warning' : 'badge-danger';
                }

                html += `
                    <tr>
                        <td>${paiement.eleveNom}</td>
                        <td>${paiement.eleveClasse}</td>
                        <td>${paiement.typeFrais}</td>
                        <td>${formatCurrency(totalDus)}</td>
                        <td>${formatCurrency(totalPayes)}</td>
                        <td>${formatCurrency(reste)}</td>
                        <td><span class="badge ${badgeClass}">${statut}</span></td>
                        <td>31/12/2024</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="voirDetailsPaiement('${paiement.eleveId}')">
                                üëÅÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function filtrerPaiements() {
            const classeId = document.getElementById('filterClassePaiements').value;
            const statut = document.getElementById('filterStatutPaiement').value;
            const mois = document.getElementById('filterMoisPaiement').value;

            let filtres = paiements;

            if (classeId) {
                const classe = classes.find(c => c.id === classeId);
                filtres = filtres.filter(p => p.eleveClasse === classe.nom);
            }

            if (statut) {
                // Filtrage par statut (simplifi√©)
                filtres = filtres.filter(p => {
                    const fraisClasse = fraisScolaires.find(f => f.classe === p.eleveClasse);
                    const totalDus = fraisClasse ? fraisClasse.frais.reduce((sum, f) => sum + f.montant, 0) : 0;
                    const totalPayes = paiements
                        .filter(px => px.eleveId === p.eleveId && px.anneeScolaire === '2024-2025')
                        .reduce((sum, px) => sum + px.montantPaye, 0);
                    const reste = totalDus - totalPayes;
                    
                    if (statut === 'pay√©') return reste <= 0;
                    if (statut === 'partiel') return reste > 0 && totalPayes > 0;
                    if (statut === 'impay√©') return reste > 0 && totalPayes === 0;
                    return true;
                });
            }

            if (mois) {
                filtres = filtres.filter(p => p.datePaiement.startsWith(mois));
            }

            return filtres;
        }

        // === FONCTIONS DE RAPPORT ===
        function genererRapportFinancier() {
            showNotification('G√©n√©ration du rapport financier...', 'info');
            
            const maintenant = new Date();
            const anneeActuelle = maintenant.getFullYear();
            
            const recettesAnnee = transactions
                .filter(t => t.type === 'recette' && new Date(t.date).getFullYear() === anneeActuelle)
                .reduce((sum, t) => sum + t.montant, 0);
            
            const depensesAnnee = transactions
                .filter(t => t.type === 'depense' && new Date(t.date).getFullYear() === anneeActuelle)
                .reduce((sum, t) => sum + t.montant, 0);
            
            const benefice = recettesAnnee - depensesAnnee;
            const tauxImpayes = eleves.length > 0 ? Math.round((calculerNombreElevesImpayes() / eleves.length) * 100) : 0;

            // Mise √† jour des statistiques de rapport
            document.getElementById('rapportRecettesAnnee').textContent = formatCurrency(recettesAnnee);
            document.getElementById('rapportDepensesAnnee').textContent = formatCurrency(depensesAnnee);
            document.getElementById('rapportBenefice').textContent = formatCurrency(benefice);
            document.getElementById('rapportTauxImpayes').textContent = tauxImpayes + '%';

            // G√©n√©ration du contenu du rapport
            const rapportContent = `
                <div style="padding: 20px;">
                    <h4>Rapport Financier ${anneeActuelle}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div>
                            <h5>Recettes par Cat√©gorie</h5>
                            ${genererDetailsParCategorie('recette')}
                        </div>
                        <div>
                            <h5>D√©penses par Cat√©gorie</h5>
                            ${genererDetailsParCategorie('depense')}
                        </div>
                    </div>
                    <div>
                        <h5>Analyse des Paiements</h5>
                        <p>Nombre total d'√©l√®ves: ${eleves.length}</p>
                        <p>√âl√®ves √† jour: ${eleves.length - calculerNombreElevesImpayes()}</p>
                        <p>√âl√®ves avec impay√©s: ${calculerNombreElevesImpayes()}</p>
                        <p>Taux de recouvrement: ${100 - tauxImpayes}%</p>
                    </div>
                </div>
            `;

            document.getElementById('contenuRapport').innerHTML = rapportContent;
            showNotification('Rapport financier g√©n√©r√© avec succ√®s!', 'success');
        }

        function genererDetailsParCategorie(type) {
            const categories = {};
            
            transactions
                .filter(t => t.type === type)
                .forEach(t => {
                    if (!categories[t.categorie]) {
                        categories[t.categorie] = 0;
                    }
                    categories[t.categorie] += t.montant;
                });

            let html = '';
            Object.entries(categories).forEach(([categorie, montant]) => {
                html += `
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>${categorie}:</span>
                        <span style="font-weight: 600;">${formatCurrency(montant)}</span>
                    </div>
                `;
            });

            return html || '<p>Aucune donn√©e</p>';
        }

        // === FONCTIONS D'EXPORT ===
        function exporterPaiementsExcel() {
            showNotification('Export Excel en cours de d√©veloppement', 'info');
        }

        function genererPDFRapport() {
            showNotification('G√©n√©ration PDF en cours de d√©veloppement', 'info');
        }

        function exporterRapportExcel() {
            showNotification('Export Excel en cours de d√©veloppement', 'info');
        }

        // === FONCTIONS D'AFFICHAGE ===
        function chargerTransactions() {
            loadFinancialData();
            showNotification('Transactions actualis√©es', 'success');
        }

        function chargerPaiements() {
            updatePaiementsTable();
            showNotification('Paiements filtr√©s', 'success');
        }

        function updateFinancialCharts() {
            showNotification('Mise √† jour des graphiques...', 'info');
            // Impl√©mentation des graphiques serait ajout√©e ici
        }

        function voirDetailsPaiement(eleveId) {
            const eleve = eleves.find(e => e.id === eleveId);
            const paiementsEleve = paiements.filter(p => p.eleveId === eleveId);
            const fraisClasse = fraisScolaires.find(f => f.classe === eleve.classe);
            
            let message = `D√©tails financiers de ${eleve.nom} ${eleve.prenom}\n\n`;
            message += `Classe: ${eleve.classe}\n`;
            message += `Matricule: ${eleve.matricule}\n\n`;
            
            if (fraisClasse) {
                message += `Frais dus: ${formatCurrency(fraisClasse.frais.reduce((sum, f) => sum + f.montant, 0))}\n`;
            }
            
            const totalPaye = paiementsEleve.reduce((sum, p) => sum + p.montantPaye, 0);
            message += `Total pay√©: ${formatCurrency(totalPaye)}\n`;
            
            const reste = fraisClasse ? fraisClasse.frais.reduce((sum, f) => sum + f.montant, 0) - totalPaye : 0;
            message += `Reste √† payer: ${formatCurrency(Math.max(0, reste))}\n\n`;
            
            message += `Derniers paiements:\n`;
            paiementsEleve.slice(0, 5).forEach(p => {
                message += `‚Ä¢ ${formatDate(p.datePaiement)} - ${formatCurrency(p.montantPaye)} (${p.typeFrais})\n`;
            });

            alert(message);
        }

        // === NOTIFICATIONS ===
        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--secondary)'};
                color: white;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // === GESTION UTILISATEUR ===
        function logout() {
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }

        // === INITIALISATION ===
        document.addEventListener('DOMContentLoaded', async function() {
            // V√©rifier la connexion
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Charger les donn√©es
            loadUserInfo();
            await loadFinancialData();
            updateDate();

            // CSS pour animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            console.log('üí∞ Module finances charg√© avec Firebase');
        });

        function loadUserInfo() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.nom;
                document.getElementById('userRole').textContent = getRoleLabel(currentUser.role);
                document.getElementById('userBadge').textContent = getRoleBadge(currentUser.role);
                document.getElementById('userBadge').className = `badge ${getRoleBadgeClass(currentUser.role)}`;
                
                if (currentUser.photo) {
                    document.getElementById('userAvatar').src = currentUser.photo;
                }
            }
        }

        function updateDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            // D√©finir le mois actuel dans le filtre
            const moisActuel = now.toISOString().slice(0, 7);
            document.getElementById('filterMoisPaiement').value = moisActuel;
        }

        function getRoleLabel(role) {
            const roles = {
                'prefet': 'Pr√©fet des √âtudes',
                'directeur_etudes': 'Directeur des √âtudes',
                'directeur_discipline': 'Directeur de Discipline',
                'econome': '√âconome',
                'secretaire': 'Secr√©taire',
                'enseignant': 'Enseignant',
                'eleve': '√âl√®ve'
            };
            return roles[role] || 'Utilisateur';
        }

        function getRoleBadge(role) {
            const badges = {
                'prefet': 'PR√âFET',
                'directeur_etudes': 'DIRECTEUR',
                'directeur_discipline': 'DISCIPLINE', 
                'econome': '√âCONOME',
                'secretaire': 'SECR√âTAIRE',
                'enseignant': 'ENSEIGNANT',
                'eleve': '√âL√àVE'
            };
            return badges[role] || 'USER';
        }

        function getRoleBadgeClass(role) {
            const classes = {
                'prefet': 'badge-danger',
                'directeur_etudes': 'badge-primary',
                'directeur_discipline': 'badge-warning',
                'econome': 'badge-success',
                'secretaire': 'badge-info',
                'enseignant': 'badge-primary',
                'eleve': 'badge-success'
            };
            return classes[role] || 'badge-info';
        }
    </script>
</body>
</html>
