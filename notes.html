<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Notes - Institut Saint Charles Lwanga</title>
    <style>
        /* STYLES EXISTANTS... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #2c3e50; --secondary: #3498db; --success: #27ae60; --warning: #f39c12; --danger: #e74c3c; --shadow: 0 4px 6px rgba(0,0,0,0.1); --radius: 10px; }
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; min-height: 100vh; color: #333; }
        
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--primary); color: white; position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-header { padding: 25px 20px; text-align: center; border-bottom: 1px solid #34495e; background: rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 12px; padding: 15px 20px; background: rgba(0,0,0,0.2); margin: 10px; border-radius: 8px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .sidebar-menu { padding: 20px 0; }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.3s; border-left: 4px solid transparent; }
        .menu-item:hover { background: #34495e; border-left-color: var(--secondary); }
        .menu-item.active { background: var(--secondary); border-left-color: white; }
        
        .main-content { margin-left: 280px; flex: 1; }
        .top-header { background: white; padding: 0 30px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .content-area { padding: 30px; background: #f8f9fa; min-height: calc(100vh - 70px); }
        .page-header { background: white; padding: 25px 30px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        
        .search-bar { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .search-bar input, .search-bar select { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-width: 200px; }
        .action-buttons { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--secondary); color: white; } .btn-success { background: var(--success); color: white; } .btn-danger { background: var(--danger); color: white; } .btn-warning { background: var(--warning); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; } .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; border-top: 4px solid var(--secondary); }
        .stat-card.success { border-top-color: var(--success); } .stat-card.warning { border-top-color: var(--warning); } .stat-card.danger { border-top-color: var(--danger); }
        .stat-number { font-size: 2.5em; font-weight: bold; color: var(--secondary); display: block; }
        .stat-card.success .stat-number { color: var(--success); } .stat-card.warning .stat-number { color: var(--warning); } .stat-card.danger .stat-number { color: var(--danger); }
        .stat-label { color: #666; margin-top: 8px; font-size: 0.9em; }
        
        .data-card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 25px; }
        .card-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; } th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: var(--dark); } tr:hover { background: #f8f9fa; }
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; } .badge-warning { background: #fff3cd; color: #856404; } .badge-danger { background: #f8d7da; color: #721c24; } .badge-primary { background: #d1ecf1; color: #0c5460; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: var(--radius); box-shadow: var(--shadow); width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; } .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--secondary); }
        
        /* Styles sp√©cifiques pour les notes */
        .notes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .note-card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; }
        .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .note-title { font-size: 1.2em; font-weight: 600; color: var(--primary); }
        .note-subtitle { color: #666; font-size: 0.9em; }
        .note-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 15px 0; }
        .note-stat { text-align: center; padding: 10px; background: #f8f9fa; border-radius: 6px; }
        .note-stat-number { font-size: 1.5em; font-weight: bold; color: var(--secondary); }
        .note-stat-label { font-size: 0.8em; color: #666; }
        
        /* Styles pour la saisie des notes */
        .saisie-notes-table { width: 100%; font-size: 0.9em; }
        .saisie-notes-table th { background: var(--primary); color: white; text-align: center; }
        .saisie-notes-table td { text-align: center; padding: 10px; }
        .note-input { width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
        .note-input:focus { outline: none; border-color: var(--secondary); }
        
        /* Styles pour les bulletins */
        .bulletin-container { background: white; padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); }
        .bulletin-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        .bulletin-title { font-size: 1.5em; font-weight: bold; color: var(--primary); margin-bottom: 10px; }
        .bulletin-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .bulletin-table th, .bulletin-table td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        .bulletin-table th { background: #f8f9fa; font-weight: 600; }
        .bulletin-signatures { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 40px; }
        .signature { text-align: center; padding-top: 40px; border-top: 1px solid #ddd; }
        
        .tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; }
        .tab { padding: 12px 24px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab.active { border-bottom-color: var(--secondary); color: var(--secondary); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        @media (max-width: 768px) { 
            .sidebar { transform: translateX(-100%); } 
            .main-content { margin-left: 0; } 
            .form-row { grid-template-columns: 1fr; } 
            .search-bar { flex-direction: column; }
            .notes-grid { grid-template-columns: 1fr; }
            .bulletin-signatures { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="logosaintcharles.JPG" alt="Logo">
                <h3>Saint Charles Lwanga</h3>
                <p style="opacity: 0.8; font-size: 0.9em;">Kolwezi</p>
            </div>

            <div class="user-info">
                <img id="userAvatar" class="user-avatar" src="" alt="Utilisateur">
                <div>
                    <div id="userName" style="font-weight: 600;">Chargement...</div>
                    <div id="userRole" style="font-size: 0.8em; opacity: 0.8;">Chargement...</div>
                </div>
            </div>

            <div class="sidebar-menu">
                <div class="menu-item" onclick="window.location.href='dashboard.html'">üìä Tableau de Bord</div>
                <div class="menu-item" onclick="window.location.href='eleves.html'">üë®‚Äçüéì √âl√®ves</div>
                <div class="menu-item" onclick="window.location.href='enseignants.html'">üë®‚Äçüè´ Enseignants</div>
                <div class="menu-item" onclick="window.location.href='classes.html'">üè´ Classes</div>
                <div class="menu-item active">üìù Notes & Bulletins</div>
                <div class="menu-item" onclick="logout()" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #34495e;">üö™ D√©connexion</div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="top-header">
                <h2>Gestion des Notes</h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="currentDate" style="color: #666;"></span>
                    <span id="userBadge" class="badge badge-success">CHARGEMENT</span>
                </div>
            </div>

            <div class="content-area">
                <!-- EN-T√äTE -->
                <div class="page-header">
                    <div>
                        <h1 style="margin-bottom: 5px;">Gestion des Notes & Bulletins</h1>
                        <p style="color: #666;">Saisie des notes et g√©n√©ration des bulletins congolais</p>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="genererBulletins()">üìÑ G√©n√©rer Bulletins</button>
                        <button class="btn btn-success" onclick="showSaisieNotesModal()">‚ûï Saisie Notes</button>
                    </div>
                </div>

                <!-- TABS -->
                <div class="tabs">
                    <div class="tab active" data-tab="saisie">üìù Saisie des Notes</div>
                    <div class="tab" data-tab="bulletins">üìä Bulletins</div>
                    <div class="tab" data-tab="statistiques">üìà Statistiques</div>
                </div>

                <!-- TAB SAISIE DES NOTES -->
                <div class="tab-content active" id="saisie-tab">
                    <!-- BARRE DE RECHERCHE -->
                    <div class="search-bar">
                        <select id="filterClasseNotes">
                            <option value="">Choisir une classe</option>
                            <!-- Charg√© dynamiquement -->
                        </select>
                        <select id="filterMatiereNotes">
                            <option value="">Choisir une mati√®re</option>
                            <!-- Charg√© dynamiquement -->
                        </select>
                        <select id="filterPeriode">
                            <option value="1">1er Trimestre</option>
                            <option value="2">2√®me Trimestre</option>
                            <option value="3">3√®me Trimestre</option>
                        </select>
                        <button class="btn btn-primary" onclick="chargerNotes()">üì• Charger les Notes</button>
                    </div>

                    <!-- TABLEAU DE SAISIE -->
                    <div class="data-card">
                        <div class="card-header">
                            <h3 id="titreSaisieNotes">S√©lectionnez une classe et une mati√®re</h3>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-success" onclick="sauvegarderNotes()" id="btnSauvegarder" disabled>
                                    üíæ Sauvegarder
                                </button>
                            </div>
                        </div>
                        <div id="tableauSaisieNotes">
                            <div style="text-align: center; padding: 40px; color: #666;">
                                S√©lectionnez une classe et une mati√®re pour commencer la saisie
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB BULLETINS -->
                <div class="tab-content" id="bulletins-tab">
                    <div class="search-bar">
                        <select id="filterClasseBulletin">
                            <option value="">Choisir une classe</option>
                            <!-- Charg√© dynamiquement -->
                        </select>
                        <select id="filterPeriodeBulletin">
                            <option value="1">1er Trimestre</option>
                            <option value="2">2√®me Trimestre</option>
                            <option value="3">3√®me Trimestre</option>
                        </select>
                        <button class="btn btn-primary" onclick="genererBulletinClasse()">üëÅÔ∏è Voir Bulletin</button>
                        <button class="btn btn-success" onclick="exporterBulletinsPDF()">üìÑ Exporter PDF</button>
                    </div>

                    <div id="apercuBulletin">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            S√©lectionnez une classe pour voir l'aper√ßu du bulletin
                        </div>
                    </div>
                </div>

                <!-- TAB STATISTIQUES -->
                <div class="tab-content" id="statistiques-tab">
                    <!-- STATISTIQUES -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalNotes">0</div>
                            <div class="stat-label">Notes saisies</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-number" id="moyenneGenerale">0.0</div>
                            <div class="stat-label">Moyenne g√©n√©rale</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-number" id="tauxReussite">0%</div>
                            <div class="stat-label">Taux de r√©ussite</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-number" id="elevesEchec">0</div>
                            <div class="stat-label">√âl√®ves en √©chec</div>
                        </div>
                    </div>

                    <div class="data-card">
                        <div class="card-header">
                            <h3>R√©partition des moyennes</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div id="graphiqueMoyennes" style="height: 300px; display: flex; align-items: end; gap: 10px; padding: 20px;">
                                <!-- Graphique des moyennes -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SAISIE NOTES -->
    <div id="saisieNotesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nouvelle Saisie de Notes</h3>
                <button onclick="closeModal('saisieNotesModal')" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úñ</button>
            </div>
            <div class="modal-body">
                <form id="saisieNotesForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="saisieClasse">Classe *</label>
                            <select id="saisieClasse" required>
                                <option value="">Choisir une classe</option>
                                <!-- Charg√© dynamiquement -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="saisieMatiere">Mati√®re *</label>
                            <select id="saisieMatiere" required>
                                <option value="">Choisir une mati√®re</option>
                                <!-- Charg√© dynamiquement -->
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="saisiePeriode">P√©riode *</label>
                            <select id="saisiePeriode" required>
                                <option value="1">1er Trimestre</option>
                                <option value="2">2√®me Trimestre</option>
                                <option value="3">3√®me Trimestre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="saisieType">Type d'√©valuation *</label>
                            <select id="saisieType" required>
                                <option value="interrogation">Interrogation</option>
                                <option value="devoir">Devoir</option>
                                <option value="examen">Examen</option>
                                <option value="composition">Composition</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="saisieDate">Date de l'√©valuation *</label>
                            <input type="date" id="saisieDate" required>
                        </div>
                        <div class="form-group">
                            <label for="saisieCoefficient">Coefficient *</label>
                            <input type="number" id="saisieCoefficient" value="1" min="1" max="10" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="saisieDescription">Description</label>
                        <textarea id="saisieDescription" rows="2" placeholder="Sujet ou th√®me de l'√©valuation..."></textarea>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('saisieNotesModal')">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-success" style="flex: 1;">
                            üìù Commencer la Saisie
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // === CONFIGURATION FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyDTM4gdOs_Ud3DC49pmammYMlDH3cSSgZs",
            authDomain: "gestion-scolaire-st-charles.firebaseapp.com",
            projectId: "gestion-scolaire-st-charles",
            storageBucket: "gestion-scolaire-st-charles.firebasestorage.app",
            messagingSenderId: "1033368821503",
            appId: "1:1033368821503:web:a4ba1c8d439193c5f336ca"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // === DONN√âES ===
        let classes = [];
        let eleves = [];
        let matieres = [];
        let notes = [];
        let currentEvaluation = null;

        // === STRUCTURE DES MATI√àRES PAR OPTION (SYST√àME CONGOLAIS) ===
        const matieresParOption = {
            'EB': [
                { nom: 'Fran√ßais', coefficient: 5 },
                { nom: 'Math√©matiques', coefficient: 4 },
                { nom: 'Sciences', coefficient: 3 },
                { nom: 'Histoire-G√©ographie', coefficient: 2 },
                { nom: 'Anglais', coefficient: 2 },
                { nom: '√âducation Civique', coefficient: 1 },
                { nom: 'EPS', coefficient: 1 }
            ],
            'P√©dagogie': [
                { nom: 'Fran√ßais', coefficient: 4 },
                { nom: 'Math√©matiques', coefficient: 3 },
                { nom: 'Sciences Physiques', coefficient: 3 },
                { nom: 'Chimie-Biologie', coefficient: 3 },
                { nom: 'Histoire', coefficient: 2 },
                { nom: 'G√©ographie', coefficient: 2 },
                { nom: '√âducation Civique', coefficient: 1 },
                { nom: 'Psychop√©dagogie', coefficient: 3 },
                { nom: 'Didactique', coefficient: 3 },
                { nom: 'EPS', coefficient: 1 }
            ],
            'Commerciale': [
                { nom: 'Fran√ßais', coefficient: 4 },
                { nom: 'Anglais', coefficient: 3 },
                { nom: 'Math√©matiques Commerciales', coefficient: 4 },
                { nom: 'Comptabilit√©', coefficient: 5 },
                { nom: 'Droit Commercial', coefficient: 3 },
                { nom: '√âconomie', coefficient: 3 },
                { nom: 'Informatique de Gestion', coefficient: 3 },
                { nom: 'Stenodactylographie', coefficient: 2 },
                { nom: 'Correspondance Commerciale', coefficient: 3 }
            ],
            'Scientifique': [
                { nom: 'Math√©matiques', coefficient: 6 },
                { nom: 'Physique', coefficient: 5 },
                { nom: 'Chimie', coefficient: 4 },
                { nom: 'Biologie', coefficient: 4 },
                { nom: 'Fran√ßais', coefficient: 4 },
                { nom: 'Anglais', coefficient: 3 },
                { nom: 'Technologie', coefficient: 3 },
                { nom: 'Informatique', coefficient: 2 }
            ],
            'Agronomie': [
                { nom: 'Agronomie G√©n√©rale', coefficient: 5 },
                { nom: 'Zootechnie', coefficient: 4 },
                { nom: '√âconomie Rurale', coefficient: 3 },
                { nom: 'Machinisme Agricole', coefficient: 3 },
                { nom: 'Sols et Fertilisation', coefficient: 4 },
                { nom: 'Fran√ßais', coefficient: 4 },
                { nom: 'Math√©matiques', coefficient: 3 },
                { nom: 'Sciences', coefficient: 3 }
            ]
        };

        // === CHARGEMENT DES DONN√âES ===
        async function loadNotesData() {
            try {
                console.log('üîÑ Chargement des donn√©es notes...');
                
                // Charger les classes
                const classesSnapshot = await db.collection('classes').where('statut', '==', 'Active').get();
                classes = [];
                classesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    classes.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Charger les √©l√®ves
                const elevesSnapshot = await db.collection('eleves').where('statut', '==', 'Actif').get();
                eleves = [];
                elevesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    eleves.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Charger les notes existantes
                const notesSnapshot = await db.collection('notes').get();
                notes = [];
                notesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    notes.push({
                        id: doc.id,
                        ...data
                    });
                });

                console.log(`‚úÖ ${classes.length} classes charg√©es`);
                console.log(`‚úÖ ${eleves.length} √©l√®ves charg√©s`);
                console.log(`‚úÖ ${notes.length} notes charg√©es`);

                populateClassesSelects();
                updateNotesStats();

            } catch (error) {
                console.error('‚ùå Erreur chargement donn√©es:', error);
                showNotification('Erreur de chargement des donn√©es', 'error');
            }
        }

        // === REMPLISSAGE DES SELECTS ===
        function populateClassesSelects() {
            const selects = [
                'filterClasseNotes', 'filterClasseBulletin', 'saisieClasse'
            ];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Choisir une classe</option>' +
                    classes.map(classe => 
                        `<option value="${classe.id}">${classe.nom}</option>`
                    ).join('');
            });
        }

        // === GESTION DES TABS ===
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // D√©sactiver tous les tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Activer le tab cliqu√©
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });

        // === MODAL SAISIE NOTES ===
        function showSaisieNotesModal() {
            document.getElementById('saisieNotesForm').reset();
            document.getElementById('saisieDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('saisieNotesModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // === GESTION MATI√àRES PAR CLASSE ===
        document.getElementById('saisieClasse').addEventListener('change', function() {
            const classeId = this.value;
            const classe = classes.find(c => c.id === classeId);
            const matiereSelect = document.getElementById('saisieMatiere');
            
            if (classe && matieresParOption[classe.option]) {
                matiereSelect.innerHTML = '<option value="">Choisir une mati√®re</option>' +
                    matieresParOption[classe.option].map(matiere => 
                        `<option value="${matiere.nom}">${matiere.nom} (Coeff: ${matiere.coefficient})</option>`
                    ).join('');
            } else {
                matiereSelect.innerHTML = '<option value="">Choisir une mati√®re</option>';
            }
        });

        // === D√âMARRER SAISIE NOTES ===
        document.getElementById('saisieNotesForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const classeId = document.getElementById('saisieClasse').value;
            const matiere = document.getElementById('saisieMatiere').value;
            const periode = document.getElementById('saisiePeriode').value;
            const type = document.getElementById('saisieType').value;
            const date = document.getElementById('saisieDate').value;
            const coefficient = parseInt(document.getElementById('saisieCoefficient').value);
            const description = document.getElementById('saisieDescription').value;

            const classe = classes.find(c => c.id === classeId);
            const elevesClasse = eleves.filter(e => e.classe === classe.nom);

            currentEvaluation = {
                classeId,
                classe: classe.nom,
                matiere,
                periode: parseInt(periode),
                type,
                date,
                coefficient,
                description,
                eleves: elevesClasse
            };

            closeModal('saisieNotesModal');
            afficherTableauSaisie();
        });

        // === AFFICHAGE TABLEAU SAISIE ===
        function afficherTableauSaisie() {
            const container = document.getElementById('tableauSaisieNotes');
            const titre = document.getElementById('titreSaisieNotes');
            const btnSauvegarder = document.getElementById('btnSauvegarder');

            titre.textContent = `Saisie des notes - ${currentEvaluation.classe} - ${currentEvaluation.matiere}`;
            btnSauvegarder.disabled = false;

            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <strong>√âvaluation:</strong> ${currentEvaluation.type} | 
                    <strong>Date:</strong> ${formatDate(currentEvaluation.date)} | 
                    <strong>Coefficient:</strong> ${currentEvaluation.coefficient}
                    ${currentEvaluation.description ? `| <strong>Description:</strong> ${currentEvaluation.description}` : ''}
                </div>
                <table class="saisie-notes-table">
                    <thead>
                        <tr>
                            <th>Matricule</th>
                            <th>Nom et Pr√©nom</th>
                            <th>Note /20</th>
                            <th>Appr√©ciation</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            currentEvaluation.eleves.forEach(eleve => {
                const noteExistante = notes.find(n => 
                    n.eleveId === eleve.id && 
                    n.matiere === currentEvaluation.matiere &&
                    n.periode === currentEvaluation.periode &&
                    n.type === currentEvaluation.type
                );

                html += `
                    <tr>
                        <td>${eleve.matricule}</td>
                        <td>${eleve.nom} ${eleve.prenom}</td>
                        <td>
                            <input type="number" 
                                   class="note-input" 
                                   min="0" 
                                   max="20" 
                                   step="0.5"
                                   value="${noteExistante ? noteExistante.note : ''}"
                                   data-eleve-id="${eleve.id}"
                                   onchange="calculerAppreciation(this)">
                        </td>
                        <td>
                            <span class="appreciation" data-eleve-id="${eleve.id}">
                                ${noteExistante ? getAppreciation(noteExistante.note) : ''}
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // === CALCUL APPR√âCIATION ===
        function calculerAppreciation(input) {
            const note = parseFloat(input.value);
            const eleveId = input.getAttribute('data-eleve-id');
            const appreciationSpan = document.querySelector(`.appreciation[data-eleve-id="${eleveId}"]`);
            
            if (!isNaN(note)) {
                appreciationSpan.textContent = getAppreciation(note);
                appreciationSpan.className = `appreciation badge ${getAppreciationBadgeClass(note)}`;
            } else {
                appreciationSpan.textContent = '';
                appreciationSpan.className = 'appreciation';
            }
        }

        function getAppreciation(note) {
            if (note >= 16) return 'Excellent';
            if (note >= 14) return 'Tr√®s Bien';
            if (note >= 12) return 'Bien';
            if (note >= 10) return 'Assez Bien';
            if (note >= 8) return 'Passable';
            return 'Insuffisant';
        }

        function getAppreciationBadgeClass(note) {
            if (note >= 16) return 'badge-success';
            if (note >= 12) return 'badge-primary';
            if (note >= 10) return 'badge-warning';
            return 'badge-danger';
        }

        // === SAUVEGARDE DES NOTES ===
        async function sauvegarderNotes() {
            try {
                const inputs = document.querySelectorAll('.note-input');
                const batch = db.batch();
                let notesSauvegardees = 0;

                for (const input of inputs) {
                    const noteValue = parseFloat(input.value);
                    const eleveId = input.getAttribute('data-eleve-id');

                    if (!isNaN(noteValue)) {
                        const noteData = {
                            eleveId: eleveId,
                            matricule: currentEvaluation.eleves.find(e => e.id === eleveId).matricule,
                            classe: currentEvaluation.classe,
                            matiere: currentEvaluation.matiere,
                            periode: currentEvaluation.periode,
                            type: currentEvaluation.type,
                            note: noteValue,
                            coefficient: currentEvaluation.coefficient,
                            dateEvaluation: currentEvaluation.date,
                            description: currentEvaluation.description,
                            dateSaisie: new Date().toISOString(),
                            saisiePar: JSON.parse(localStorage.getItem('currentUser')).email
                        };

                        // V√©rifier si la note existe d√©j√†
                        const noteExistante = notes.find(n => 
                            n.eleveId === eleveId && 
                            n.matiere === currentEvaluation.matiere &&
                            n.periode === currentEvaluation.periode &&
                            n.type === currentEvaluation.type
                        );

                        if (noteExistante) {
                            // Mettre √† jour
                            const docRef = db.collection('notes').doc(noteExistante.id);
                            batch.update(docRef, noteData);
                        } else {
                            // Nouvelle note
                            const docRef = db.collection('notes').doc();
                            batch.set(docRef, noteData);
                        }

                        notesSauvegardees++;
                    }
                }

                await batch.commit();
                showNotification(`${notesSauvegardees} notes sauvegard√©es avec succ√®s!`, 'success');
                
                // Recharger les notes
                await loadNotesData();
                
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde notes:', error);
                showNotification('Erreur lors de la sauvegarde', 'error');
            }
        }

        // === G√âN√âRATION BULLETINS ===
        async function genererBulletinClasse() {
            const classeId = document.getElementById('filterClasseBulletin').value;
            const periode = parseInt(document.getElementById('filterPeriodeBulletin').value);
            
            if (!classeId) {
                showNotification('Veuillez s√©lectionner une classe', 'warning');
                return;
            }

            const classe = classes.find(c => c.id === classeId);
            const elevesClasse = eleves.filter(e => e.classe === classe.nom);
            const notesClasse = notes.filter(n => n.classe === classe.nom && n.periode === periode);

            // Calculer les moyennes par √©l√®ve
            const bulletins = elevesClasse.map(eleve => {
                const notesEleve = notesClasse.filter(n => n.eleveId === eleve.id);
                return calculerBulletinEleve(eleve, notesEleve, classe.option, periode);
            });

            afficherApercuBulletin(bulletins, classe, periode);
        }

        function calculerBulletinEleve(eleve, notesEleve, option, periode) {
            const matieresOption = matieresParOption[option] || [];
            const bulletin = {
                eleve: eleve,
                periode: periode,
                matieres: [],
                moyenneGenerale: 0,
                totalPoints: 0,
                totalCoefficients: 0,
                appreciation: '',
                rang: 0
            };

            // Calcul par mati√®re
            matieresOption.forEach(matiereConfig => {
                const notesMatiere = notesEleve.filter(n => n.matiere === matiereConfig.nom);
                const moyenneMatiere = calculerMoyenneMatiere(notesMatiere);
                const points = moyenneMatiere * matiereConfig.coefficient;

                bulletin.matieres.push({
                    nom: matiereConfig.nom,
                    coefficient: matiereConfig.coefficient,
                    moyenne: moyenneMatiere,
                    points: points,
                    appreciation: getAppreciation(moyenneMatiere * 2) // Convertir /10 vers /20
                });

                bulletin.totalPoints += points;
                bulletin.totalCoefficients += matiereConfig.coefficient;
            });

            // Calcul moyenne g√©n√©rale
            if (bulletin.totalCoefficients > 0) {
                bulletin.moyenneGenerale = bulletin.totalPoints / bulletin.totalCoefficients;
            }

            // Appr√©ciation g√©n√©rale
            bulletin.appreciation = getAppreciation(bulletin.moyenneGenerale * 2);

            return bulletin;
        }

        function calculerMoyenneMatiere(notesMatiere) {
            if (notesMatiere.length === 0) return 0;
            
            let totalPondere = 0;
            let totalCoefficients = 0;

            notesMatiere.forEach(note => {
                totalPondere += note.note * note.coefficient;
                totalCoefficients += note.coefficient;
            });

            return totalCoefficients > 0 ? totalPondere / totalCoefficients : 0;
        }

        function afficherApercuBulletin(bulletins, classe, periode) {
            const container = document.getElementById('apercuBulletin');
            
            // Trier par moyenne g√©n√©rale
            bulletins.sort((a, b) => b.moyenneGenerale - a.moyenneGenerale);
            
            // Assigner les rangs
            bulletins.forEach((bulletin, index) => {
                bulletin.rang = index + 1;
            });

            let html = `
                <div class="bulletin-container">
                    <div class="bulletin-header">
                        <div class="bulletin-title">R√âPUBLIQUE D√âMOCRATIQUE DU CONGO</div>
                        <div>Minist√®re de l'Enseignement Primaire, Secondaire et Technique</div>
                        <div><strong>INSTITUT SAINT CHARLES LWANGA - KOLWEZI</strong></div>
                        <div>BULLETIN DE NOTES - ${periode}√®me TRIMESTRE ${new Date().getFullYear()}</div>
                        <div>CLASSE: ${classe.nom}</div>
                    </div>

                    <table class="bulletin-table">
                        <thead>
                            <tr>
                                <th rowspan="2">Rang</th>
                                <th rowspan="2">Nom et Pr√©nom</th>
                                ${bulletins[0]?.matieres.map(m => `<th>${m.nom}<br>Coeff: ${m.coefficient}</th>`).join('')}
                                <th rowspan="2">Moyenne<br>G√©n√©rale</th>
                                <th rowspan="2">Appr√©ciation</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            bulletins.forEach(bulletin => {
                html += `
                    <tr>
                        <td>${bulletin.rang}</td>
                        <td style="text-align: left;">${bulletin.eleve.nom} ${bulletin.eleve.prenom}</td>
                        ${bulletin.matieres.map(m => `<td>${m.moyenne.toFixed(2)}</td>`).join('')}
                        <td><strong>${bulletin.moyenneGenerale.toFixed(2)}</strong></td>
                        <td>${bulletin.appreciation}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>

                    <div class="bulletin-signatures">
                        <div class="signature">
                            Le Pr√©fet des √âtudes<br>
                            P√®re Michel Lembe
                        </div>
                        <div class="signature">
                            Le Directeur des √âtudes<br>
                            Mr Delphin Kagunge
                        </div>
                        <div class="signature">
                            Le Professeur Principal
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // === STATISTIQUES ===
        function updateNotesStats() {
            const notesValides = notes.filter(n => !isNaN(n.note));
            const totalNotes = notesValides.length;
            
            if (totalNotes > 0) {
                const moyenneGenerale = notesValides.reduce((sum, n) => sum + n.note, 0) / totalNotes;
                const notesReussite = notesValides.filter(n => n.note >= 10).length;
                const tauxReussite = Math.round((notesReussite / totalNotes) * 100);
                
                document.getElementById('totalNotes').textContent = totalNotes;
                document.getElementById('moyenneGenerale').textContent = moyenneGenerale.toFixed(1);
                document.getElementById('tauxReussite').textContent = tauxReussite + '%';
                
                // Calcul √©l√®ves en √©chec (simplifi√©)
                const elevesAvecNotes = [...new Set(notesValides.map(n => n.eleveId))];
                document.getElementById('elevesEchec').textContent = Math.round(elevesAvecNotes.length * 0.1); // Estimation
            }
        }

        // === FONCTIONS UTILITAIRES ===
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR');
        }

        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--secondary)'};
                color: white;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function genererBulletins() {
            showNotification('G√©n√©ration des bulletins en cours...', 'info');
        }

        function exporterBulletinsPDF() {
            showNotification('Export PDF en cours de d√©veloppement', 'info');
        }

        function chargerNotes() {
            showNotification('Chargement des notes...', 'info');
        }

        // === INITIALISATION ===
        document.addEventListener('DOMContentLoaded', async function() {
            // V√©rifier la connexion
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Charger les donn√©es
            loadUserInfo();
            await loadNotesData();
            updateDate();

            // CSS pour animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            console.log('üìù Module notes charg√© avec Firebase');
        });

        function loadUserInfo() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.nom;
                document.getElementById('userRole').textContent = getRoleLabel(currentUser.role);
                document.getElementById('userBadge').textContent = getRoleBadge(currentUser.role);
                document.getElementById('userBadge').className = `badge ${getRoleBadgeClass(currentUser.role)}`;
                
                if (currentUser.photo) {
                    document.getElementById('userAvatar').src = currentUser.photo;
                }
            }
        }

        function updateDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
        }

        function getRoleLabel(role) {
            const roles = {
                'prefet': 'Pr√©fet des √âtudes',
                'directeur_etudes': 'Directeur des √âtudes',
                'directeur_discipline': 'Directeur de Discipline',
                'econome': '√âconome',
                'secretaire': 'Secr√©taire',
                'enseignant': 'Enseignant',
                'eleve': '√âl√®ve'
            };
            return roles[role] || 'Utilisateur';
        }

        function getRoleBadge(role) {
            const badges = {
                'prefet': 'PR√âFET',
                'directeur_etudes': 'DIRECTEUR',
                'directeur_discipline': 'DISCIPLINE', 
                'econome': '√âCONOME',
                'secretaire': 'SECR√âTAIRE',
                'enseignant': 'ENSEIGNANT',
                'eleve': '√âL√àVE'
            };
            return badges[role] || 'USER';
        }

        function getRoleBadgeClass(role) {
            const classes = {
                'prefet': 'badge-danger',
                'directeur_etudes': 'badge-primary',
                'directeur_discipline': 'badge-warning',
                'econome': 'badge-success',
                'secretaire': 'badge-info',
                'enseignant': 'badge-primary',
                'eleve': 'badge-success'
            };
            return classes[role] || 'badge-info';
        }
    </script>
</body>
</html>
