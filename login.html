<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion - Solution Ultime</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a365d 0%, #2d5aa0 100%);
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
        .container { width: 100%; max-width: 400px; }
        .card { background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #1a365d; color: white; padding: 30px 20px; text-align: center; }
        .content { padding: 30px; }
        .btn { padding: 15px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .btn-primary { background: #2d5aa0; color: white; }
        .btn-success { background: #2e7d32; color: white; }
        .btn-danger { background: #d32f2f; color: white; }
        .hidden { display: none !important; }
        .message { padding: 12px; border-radius: 6px; margin-top: 15px; text-align: center; }
        .error { background: #fef2f2; color: #d32f2f; border: 1px solid #fed7d7; }
        .success { background: #f0fff4; color: #2e7d32; border: 1px solid #c6f6d5; }
        .debug { background: #e3f2fd; padding: 10px; border-radius: 6px; margin-top: 15px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>üö® SOLUTION ULTIME</h1>
                <p>Institut Saint Charles Lwanga</p>
            </div>
            
            <div class="content">
                <button class="btn btn-danger" onclick="solutionUltime()" id="mainBtn">
                    üî• CLIQUEZ ICI POUR CONNEXION
                </button>
                
                <div class="debug" id="debugInfo">
                    <strong>Mode diagnostic activ√©</strong><br>
                    En attente d'action...
                </div>
                
                <div id="errorMessage" class="message error hidden"></div>
                <div id="successMessage" class="message success hidden"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // CONFIGURATION FIREBASE UNIFI√âE
        const firebaseConfig = {
            apiKey: "AIzaSyDTM4gdOs_Ud3DC49pmammYMlDH3cSSgZs",
            authDomain: "gestion-scolaire-st-charles.firebaseapp.com",
            projectId: "gestion-scolaire-st-charles",
            storageBucket: "gestion-scolaire-st-charles.appspot.com",
            messagingSenderId: "1033368821503",
            appId: "1:1033368821503:web:a4ba1c8d439193c5f336ca"
        };

        // Initialisation Firebase
        let auth, db;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('‚úÖ Firebase initialis√© avec succ√®s');
            updateDebug('‚úÖ Firebase initialis√©');
        } catch (error) {
            console.log('‚ÑπÔ∏è Firebase d√©j√† initialis√©');
            auth = firebase.auth();
            db = firebase.firestore();
            updateDebug('‚ÑπÔ∏è Firebase instance existante utilis√©e');
        }

        // FONCTION ULTIME
        async function solutionUltime() {
            const btn = document.getElementById('mainBtn');
            btn.disabled = true;
            btn.innerHTML = 'üîÑ TRAITEMENT EN COURS...';
            
            clearMessages();
            updateDebug('D√©but de la proc√©dure ultime...');

            try {
                // √âTAPE 1: Authentification
                updateDebug('√âtape 1: Authentification Firebase...');
                const userCredential = await auth.signInWithEmailAndPassword('prefet@stcharles.edu', 'prefet123');
                const user = userCredential.user;
                updateDebug(`‚úÖ Authentifi√©: ${user.uid}`);
                console.log('UID utilisateur:', user.uid);

                // √âTAPE 2: Donn√©es utilisateur
                const userData = {
                    id: 'U001',
                    nom: 'P√®re Michel Lembe',
                    role: 'prefet',
                    telephone: '+243 97 001 0001',
                    statut: 'Actif',
                    email: 'prefet@stcharles.edu',
                    authUid: user.uid,
                    permissions: {
                        dashboard: { read: true, write: true },
                        eleves: { read: true, write: true },
                        enseignants: { read: true, write: true },
                        classes: { read: true, write: true },
                        notes: { read: true, write: true },
                        finances: { read: true, write: true },
                        discipline: { read: true, write: true },
                        emploi_temps: { read: true, write: true },
                        rapports: { read: true, write: true }
                    },
                    dateCreation: new Date().toISOString()
                };

                // √âTAPE 3: Sauvegarde Firestore
                updateDebug('√âtape 2: Sauvegarde dans Firestore...');
                await db.collection('users').doc(user.uid).set(userData);
                updateDebug('‚úÖ Donn√©es sauvegard√©es dans Firestore');

                // √âTAPE 4: Stockage localStorage
                updateDebug('√âtape 3: Configuration session...');
                localStorage.setItem('currentUser', JSON.stringify(userData));
                localStorage.setItem('userPermissions', JSON.stringify(userData.permissions));
                updateDebug('‚úÖ Session configur√©e');

                // √âTAPE 5: Redirection
                updateDebug('√âtape 4: Redirection vers dashboard...');
                showSuccess('üéâ CONNEXION R√âUSSIE ! Redirection...');
                
                btn.innerHTML = '‚úÖ SUCC√àS - Redirection...';
                
                // Redirection garantie
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('‚ùå Erreur compl√®te:', error);
                updateDebug(`‚ùå ERREUR: ${error.message}`);
                showError(`√âchec: ${error.message}`);
                btn.innerHTML = '‚ùå √âCHEC - Cliquez pour r√©essayer';
                btn.disabled = false;
            }
        }

        // FONCTIONS UTILITAIRES
        function updateDebug(message) {
            const debug = document.getElementById('debugInfo');
            debug.innerHTML += `<br>${message}`;
            debug.scrollTop = debug.scrollHeight;
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successMessage').classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        function clearMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        // V√âRIFICATION INITIALE
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Solution ultime charg√©e');
            
            // V√©rifier si d√©j√† connect√©
            if (localStorage.getItem('currentUser')) {
                updateDebug('‚ÑπÔ∏è Utilisateur d√©j√† connect√©, redirection...');
                window.location.href = 'dashboard.html';
                return;
            }

            // V√©rifier l'√©tat d'authentification
            auth.onAuthStateChanged((user) => {
                if (user) {
                    updateDebug(`‚ÑπÔ∏è Utilisateur Firebase connect√©: ${user.email}`);
                }
            });
        });
    </script>
</body>
</html>
